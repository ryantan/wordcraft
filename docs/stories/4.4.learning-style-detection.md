# Story 4.4: Implement Learning Style Detection

## Status

Draft

## Story

**As a** developer,
**I want** to analyze game performance across different game types to detect learning style preferences,
**so that** the system can emphasize effective game mechanics for each child.

## Acceptance Criteria

1. A `/lib/algorithms/learning-style-detection.ts` module is created
2. Algorithm tracks performance metrics by game type (visual, auditory, kinesthetic)
3. Algorithm calculates success rate, average attempts, and speed for each category
4. Learning style profile is determined after minimum 10-15 game results (enough data)
5. Profile indicates primary and secondary learning styles (e.g., 60% visual, 30% kinesthetic, 10% auditory)
6. Algorithm updates incrementally as more data is collected
7. Default profile is balanced (33% each) until sufficient data exists
8. Unit tests verify detection logic with sample game result datasets

## Tasks / Subtasks

- [ ] Create learning style detection module (AC: 1, 2)
  - [ ] Create file `/lib/algorithms/learning-style-detection.ts`
  - [ ] Define learning style categories: `visual`, `auditory`, `kinesthetic`
  - [ ] Create mapping of game types to learning styles (e.g., Word Scramble → visual)
  - [ ] Document game-to-style mappings in code comments

- [ ] Define data structures (AC: 2, 3)
  - [ ] Create `LearningStyleProfile` type in `/types/game.ts`:
    - `visual: number` (0-1 score)
    - `auditory: number` (0-1 score)
    - `kinesthetic: number` (0-1 score)
    - `confidence: number` (how confident in this profile)
    - `totalGamesAnalyzed: number`
  - [ ] Create `StyleMetrics` type for tracking performance per style

- [ ] Implement performance tracking by style (AC: 2, 3)
  - [ ] Create `trackPerformance(results: GameResult[])` function
  - [ ] Group game results by learning style category
  - [ ] Calculate success rate for each style (correct / total)
  - [ ] Calculate average attempts for each style
  - [ ] Calculate average time taken for each style
  - [ ] Combine metrics into overall style score

- [ ] Implement profile calculation (AC: 4, 5)
  - [ ] Create `detectLearningStyle(results: GameResult[])` function
  - [ ] Require minimum 10-15 results before generating profile
  - [ ] Calculate weighted scores for each style based on:
    - Success rate (50% weight)
    - Speed (30% weight - faster indicates preference)
    - Fewer attempts (20% weight)
  - [ ] Normalize scores to percentages (sum = 100%)
  - [ ] Return primary and secondary styles

- [ ] Implement incremental updates (AC: 6)
  - [ ] Create `updateProfile(currentProfile, newResults)` function
  - [ ] Use running average to incorporate new data
  - [ ] Give more weight to recent results (recency bias)
  - [ ] Update confidence score as more data is collected

- [ ] Handle insufficient data case (AC: 7)
  - [ ] Return default profile if < 10 results: `{ visual: 0.33, auditory: 0.33, kinesthetic: 0.33, confidence: 0 }`
  - [ ] Increase confidence score as data accumulates
  - [ ] Confidence reaches 1.0 after ~30+ results

- [ ] Map game types to learning styles
  - [ ] Define game-to-style mapping:
    - Visual: Word Scramble, Missing Letters, Picture Reveal
    - Kinesthetic: Letter Hunt, Trace & Write, Word Building Blocks
    - Visual+Kinesthetic: Letter Matching
    - Auditory: Spelling Challenge (with future audio)
  - [ ] Create helper function `getGameStyle(gameType): LearningStyle`

- [ ] Create comprehensive unit tests (AC: 8)
  - [ ] Create test file `/lib/algorithms/learning-style-detection.test.ts`
  - [ ] Test: Default profile with < 10 results
  - [ ] Test: Profile converges to visual with high visual game success
  - [ ] Test: Profile shows mixed preferences with balanced results
  - [ ] Test: Incremental updates adjust profile correctly
  - [ ] Test: Confidence increases with more data
  - [ ] Test: Recent results weighted more heavily
  - [ ] Run tests with `npm run test`

## Dev Notes

### Architecture Context

**File Structure:**
[Source: docs/ui-architecture.md#Project Structure]
```
lib/
├── algorithms/
│   ├── learning-style-detection.ts      # Learning style algorithm
│   ├── learning-style-detection.test.ts # Unit tests
```

**Learning Styles Overview:**
[Source: docs/prd.md#Epic 4 - Story 4.4]

Three learning style categories:
1. **Visual**: Learn best by seeing (images, patterns, visual organization)
2. **Auditory**: Learn best by hearing (sounds, spoken words, rhythm)
3. **Kinesthetic**: Learn best by doing (movement, touch, physical interaction)

**Game Type Mapping:**
```typescript
const gameStyleMap: Record<GameType, LearningStyle[]> = {
  'word-scramble': ['visual'],
  'missing-letters': ['visual'],
  'letter-matching': ['visual', 'kinesthetic'],
  'spelling-challenge': ['auditory'], // Future: will have audio
  'letter-hunt': ['kinesthetic', 'visual'],
  'trace-write': ['kinesthetic'],
  'picture-reveal': ['visual'],
  'word-building': ['kinesthetic', 'visual']
}
```

**Detection Algorithm:**
```typescript
// Pseudocode
function detectLearningStyle(results: GameResult[]): LearningStyleProfile {
  if (results.length < 10) {
    return DEFAULT_PROFILE // 33% each, confidence 0
  }

  // Group results by learning style
  const styleMetrics = {
    visual: calculateMetrics(results.filter(r => isVisualGame(r.gameType))),
    auditory: calculateMetrics(results.filter(r => isAuditoryGame(r.gameType))),
    kinesthetic: calculateMetrics(results.filter(r => isKinestheticGame(r.gameType)))
  }

  // Calculate scores (0-1)
  const scores = {
    visual: calculateStyleScore(styleMetrics.visual),
    auditory: calculateStyleScore(styleMetrics.auditory),
    kinesthetic: calculateStyleScore(styleMetrics.kinesthetic)
  }

  // Normalize to percentages
  const total = scores.visual + scores.auditory + scores.kinesthetic
  const profile = {
    visual: scores.visual / total,
    auditory: scores.auditory / total,
    kinesthetic: scores.kinesthetic / total,
    confidence: Math.min(results.length / 30, 1.0),
    totalGamesAnalyzed: results.length
  }

  return profile
}

function calculateStyleScore(metrics: StyleMetrics): number {
  const successWeight = 0.5
  const speedWeight = 0.3
  const attemptsWeight = 0.2

  const successScore = metrics.successRate
  const speedScore = 1 - (metrics.averageTime / maxExpectedTime)
  const attemptsScore = 1 - (metrics.averageAttempts / maxExpectedAttempts)

  return (
    successScore * successWeight +
    speedScore * speedWeight +
    attemptsScore * attemptsWeight
  )
}
```

**Integration Points:**
- Story 4.2 (Adaptive Engine Machine): Will call this in `detectingStyle` state
- Story 4.5 (Adaptive Game Selection): Will use profile to select games

### Dependencies

**Required:**
- Story 4.1 (Confidence Scoring) - Provides `GameResult` type
- Story 4.2 (Adaptive Engine Machine) - Will store profile in context

**Future Integration:**
- Story 4.5 (Adaptive Game Selection) - Will use learning style profile

### Testing

[Source: docs/ui-architecture.md#Testing Strategy]

**Testing Framework:** Vitest
**Test Location:** `/lib/algorithms/learning-style-detection.test.ts`
**Coverage Target:** 70%+

**Test Scenarios:**
```typescript
import { describe, it, expect } from 'vitest'
import { detectLearningStyle } from './learning-style-detection'

describe('Learning Style Detection', () => {
  it('returns default profile with < 10 results', () => {
    const results = createMockResults(5)
    const profile = detectLearningStyle(results)

    expect(profile.visual).toBeCloseTo(0.33, 1)
    expect(profile.auditory).toBeCloseTo(0.33, 1)
    expect(profile.kinesthetic).toBeCloseTo(0.33, 1)
    expect(profile.confidence).toBe(0)
  })

  it('detects visual preference with high visual game success', () => {
    const results = [
      ...createSuccessfulResults('word-scramble', 10),
      ...createFailedResults('letter-hunt', 5)
    ]
    const profile = detectLearningStyle(results)

    expect(profile.visual).toBeGreaterThan(0.5)
  })

  it('confidence increases with more data', () => {
    const profile15 = detectLearningStyle(createMockResults(15))
    const profile30 = detectLearningStyle(createMockResults(30))

    expect(profile30.confidence).toBeGreaterThan(profile15.confidence)
  })
})
```

**Run Tests:**
```bash
npm run test
npm run test:coverage
```

### Technical Constraints

- Pure functions: No side effects
- TypeScript strict mode
- Performance: Handle 100+ results efficiently (<50ms)
- Recency bias: Recent results weighted more heavily (use exponential decay)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
