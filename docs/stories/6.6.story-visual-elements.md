# Story 6.6: Add Visual Story Elements to Game UI

## Status

Draft

## Story

**As a** child,
**I want** to see story-themed visual elements during gameplay,
**so that** I feel immersed in the adventure even while playing games.

## Acceptance Criteria

1. Game session UI includes a subtle story banner/header showing current checkpoint
2. Character sprite appears in a corner or edge of the game screen (non-intrusive)
3. Progress bar or indicator shows advancement toward next checkpoint
4. Visual theme (colors, backgrounds) aligns with selected story theme
5. Story elements don't obscure game interactions or distract from gameplay
6. Elements are visible but not dominant (games remain the focus)
7. Responsive design ensures story elements scale appropriately on mobile
8. Visual polish: smooth transitions, subtle animations for story elements

## Tasks / Subtasks

- [ ] Create StoryBanner component (AC: 1, 4, 7, 8)
  - [ ] Create file `/components/story/StoryBanner.tsx`
  - [ ] Component props:
    ```typescript
    interface StoryBannerProps {
      theme: string
      currentCheckpoint: number
      checkpointTitle: string
    }
    ```
  - [ ] Compact horizontal layout
  - [ ] Display current checkpoint name/icon
  - [ ] Theme colors and styling
  - [ ] Responsive sizing for mobile/desktop

- [ ] Design banner layout (AC: 1, 5, 6)
  - [ ] Position: Top of game screen, fixed header
  - [ ] Height: Small (40-60px), doesn't consume much space
  - [ ] Content:
    - Checkpoint icon (star, planet, etc.)
    - Checkpoint name ("Moon Landing", "Mars Mission")
    - Theme color accent
  - [ ] Style: Semi-transparent background, subtle shadow
  - [ ] Visual hierarchy: Clear but not distracting

- [ ] Create CharacterWidget component (AC: 2, 5, 6, 7, 8)
  - [ ] Create file `/components/story/CharacterWidget.tsx`
  - [ ] Component props:
    ```typescript
    interface CharacterWidgetProps {
      theme: string
      characterState: 'neutral' | 'thinking' | 'celebrating'
      position: 'bottom-left' | 'bottom-right' | 'top-right'
    }
    ```
  - [ ] Small character sprite (64x64 to 128x128px)
  - [ ] Positioned in corner, non-intrusive
  - [ ] Optional speech bubble for hints/encouragement
  - [ ] Animated state changes

- [ ] Design character widget (AC: 2, 5, 6)
  - [ ] Position: Bottom-left or bottom-right corner
  - [ ] Size: Small (64-128px), scalable
  - [ ] Character pose changes based on game state:
    - Neutral during gameplay
    - Thinking when player struggling
    - Celebrating when player succeeds
  - [ ] Semi-transparent or with subtle shadow
  - [ ] Doesn't block game interaction areas

- [ ] Create ProgressIndicator component (AC: 3, 7, 8)
  - [ ] Create file `/components/story/ProgressIndicator.tsx`
  - [ ] Component props:
    ```typescript
    interface ProgressIndicatorProps {
      gamesCompleted: number
      gamesUntilNextCheckpoint: number
      nextCheckpointTitle: string
    }
    ```
  - [ ] Visual progress bar or dots
  - [ ] Shows advancement toward next checkpoint
  - [ ] Compact, fits in banner or separate section
  - [ ] Responsive design

- [ ] Design progress indicator (AC: 3, 6)
  - [ ] Visual options:
    - Option A: Linear progress bar with milestone markers
    - Option B: Dot/star sequence (filled vs unfilled)
    - Option C: Circular progress indicator
  - [ ] Display: "3/5 games until next milestone"
  - [ ] Color: Theme-appropriate (space = blue/purple, treasure = gold/brown)
  - [ ] Size: Compact, integrates with banner or separate widget
  - [ ] Animation: Smooth fill or dot lighting up when game completed

- [ ] Implement theme color system (AC: 4)
  - [ ] Create `/lib/story/theme-colors.ts`:
    ```typescript
    export const STORY_THEME_COLORS = {
      space: {
        primary: '#4A5FFF',
        secondary: '#FFB84D',
        accent: '#A78BFA',
        background: '#1E1B4B',
        text: '#F8FAFC'
      },
      treasure: {
        primary: '#D97706',
        secondary: '#FCD34D',
        accent: '#92400E',
        background: '#78350F',
        text: '#FFFBEB'
      },
      fantasy: {
        primary: '#7C3AED',
        secondary: '#EC4899',
        accent: '#10B981',
        background: '#581C87',
        text: '#FAE8FF'
      }
    }
    ```
  - [ ] Apply colors dynamically based on selected theme
  - [ ] CSS custom properties for theme switching

- [ ] Apply theme styling to game container (AC: 4)
  - [ ] Add theme-based background gradient or pattern
  - [ ] Subtle, doesn't distract from game
  - [ ] Example: Space theme adds starfield background
  - [ ] Treasure theme adds parchment texture
  - [ ] Fantasy theme adds mystical glow effects

- [ ] Implement character state changes (AC: 2, 8)
  - [ ] Listen to game events:
    - Game start ‚Üí Neutral pose
    - Hint requested ‚Üí Thinking pose
    - Correct answer ‚Üí Celebrating pose
    - Wrong answer ‚Üí Encouraging pose
  - [ ] Smooth sprite transitions with Framer Motion
  - [ ] Optional: Speech bubbles with encouraging messages
    - "You can do it!"
    - "Great job!"
    - "Try again!"

- [ ] Add progress bar animations (AC: 8)
  - [ ] Smooth fill animation when game completed
  - [ ] Pulse or glow effect when nearing checkpoint
  - [ ] Celebration burst when checkpoint reached
  - [ ] Use CSS transitions or Framer Motion
  - [ ] Maintain 60fps performance

- [ ] Create StoryUIContainer component (AC: 1, 2, 3)
  - [ ] Wrapper component that adds all story elements
  - [ ] Props:
    ```typescript
    interface StoryUIContainerProps {
      theme: string
      storyProgress: StoryProgressContext
      children: React.ReactNode
    }
    ```
  - [ ] Renders: StoryBanner, CharacterWidget, ProgressIndicator
  - [ ] Wraps game components
  - [ ] Example usage:
    ```tsx
    <StoryUIContainer theme="space" storyProgress={progress}>
      <WordScrambleGame {...gameProps} />
    </StoryUIContainer>
    ```

- [ ] Implement responsive layout (AC: 7)
  - [ ] Mobile (375px):
    - Banner: Thinner (40px height)
    - Character: Smaller (64x64px)
    - Progress: Simplified dots instead of bar
    - All elements scale down appropriately
  - [ ] Tablet (768px):
    - Banner: Standard (50px height)
    - Character: Medium (96x96px)
    - Progress: Full bar with labels
  - [ ] Desktop (1920px):
    - Banner: Full (60px height)
    - Character: Larger (128x128px)
    - Progress: Detailed with text and icons
  - [ ] Test all breakpoints

- [ ] Add subtle background elements (AC: 4, 5, 6)
  - [ ] Space theme: Twinkling stars, slow-moving planets
  - [ ] Treasure theme: Drifting coins, subtle wave animation
  - [ ] Fantasy theme: Floating sparkles, magical glow
  - [ ] Implemented as CSS animations or canvas
  - [ ] Very subtle, doesn't distract
  - [ ] Can be disabled for performance

- [ ] Implement show/hide toggle (AC: 5)
  - [ ] Allow users to minimize story elements if desired
  - [ ] Small toggle button: "Hide Story Elements"
  - [ ] Preference saved in localStorage
  - [ ] Useful for focus mode or accessibility

- [ ] Add accessibility considerations
  - [ ] Story banner has proper ARIA labels
  - [ ] Character widget is decorative (aria-hidden if not interactive)
  - [ ] Progress indicator has text alternative
  - [ ] Color contrast meets WCAG AA standards
  - [ ] Elements don't interfere with screen readers

- [ ] Optimize performance (AC: 8)
  - [ ] Use CSS transforms for animations (GPU accelerated)
  - [ ] Debounce progress updates
  - [ ] Lazy load character sprites
  - [ ] Minimize re-renders with React.memo
  - [ ] Test on low-end devices

- [ ] Create integration with GameSessionMachine
  - [ ] Connect story UI to machine state
  - [ ] Update character pose based on game events
  - [ ] Update progress based on games completed
  - [ ] Update banner when checkpoint changes
  - [ ] Example:
    ```typescript
    const { storyProgress, gameState } = useActor(gameSessionMachine)

    const characterState = useMemo(() => {
      if (gameState.matches('completed') && gameState.context.isCorrect) {
        return 'celebrating'
      }
      if (gameState.context.hintsUsed > 0) {
        return 'thinking'
      }
      return 'neutral'
    }, [gameState])
    ```

- [ ] Create component tests
  - [ ] Create test file `/components/story/StoryBanner.test.tsx`
  - [ ] Test: Renders checkpoint info correctly
  - [ ] Test: Applies theme colors
  - [ ] Test: Responsive sizing
  - [ ] Create test file `/components/story/CharacterWidget.test.tsx`
  - [ ] Test: Renders character sprite
  - [ ] Test: Changes pose based on state
  - [ ] Test: Positioned correctly
  - [ ] Create test file `/components/story/ProgressIndicator.test.tsx`
  - [ ] Test: Displays progress accurately
  - [ ] Test: Animates on update
  - [ ] Test: Shows games until next checkpoint
  - [ ] Run tests with `npm run test`

## Dev Notes

### Architecture Context

**StoryBanner Component:**
```typescript
'use client'

import { motion } from 'framer-motion'
import { STORY_THEME_COLORS } from '@/lib/story/theme-colors'

interface StoryBannerProps {
  theme: string
  currentCheckpoint: number
  checkpointTitle: string
}

export function StoryBanner({
  theme = 'space',
  currentCheckpoint,
  checkpointTitle
}: StoryBannerProps) {
  const colors = STORY_THEME_COLORS[theme]

  const getCheckpointIcon = (checkpoint: number) => {
    const icons = ['üöÄ', 'üåô', 'üî¥', 'ü™ê', '‚≠ê']
    return icons[checkpoint] || 'üåü'
  }

  return (
    <motion.div
      className="fixed top-0 left-0 right-0 z-40 h-14 md:h-16 flex items-center justify-between px-4 md:px-6 shadow-lg"
      style={{
        backgroundColor: `${colors.primary}E6`, // 90% opacity
        borderBottom: `3px solid ${colors.accent}`
      }}
      initial={{ y: -100 }}
      animate={{ y: 0 }}
      transition={{ type: 'spring' }}
    >
      <div className="flex items-center gap-3">
        <span className="text-3xl md:text-4xl">
          {getCheckpointIcon(currentCheckpoint)}
        </span>
        <div>
          <div className="text-xs md:text-sm text-white/80 font-semibold">
            Current Milestone
          </div>
          <div className="text-sm md:text-lg text-white font-bold">
            {checkpointTitle}
          </div>
        </div>
      </div>

      {/* Progress indicator could go here */}
    </motion.div>
  )
}
```

**CharacterWidget Component:**
```typescript
'use client'

import { motion, AnimatePresence } from 'framer-motion'
import { STORY_ASSETS } from '@/lib/story/assets'

interface CharacterWidgetProps {
  theme: string
  characterState: 'neutral' | 'thinking' | 'celebrating'
  position?: 'bottom-left' | 'bottom-right'
  message?: string
}

export function CharacterWidget({
  theme = 'space',
  characterState = 'neutral',
  position = 'bottom-right',
  message
}: CharacterWidgetProps) {
  const assets = STORY_ASSETS[theme]
  const characterImage = assets.characters[characterState]

  const positionStyles = {
    'bottom-left': 'bottom-4 left-4',
    'bottom-right': 'bottom-4 right-4'
  }

  return (
    <motion.div
      className={`fixed ${positionStyles[position]} z-30`}
      initial={{ scale: 0, opacity: 0 }}
      animate={{ scale: 1, opacity: 1 }}
      transition={{ type: 'spring' }}
    >
      {/* Speech bubble */}
      <AnimatePresence>
        {message && (
          <motion.div
            className="absolute bottom-full mb-2 right-0 bg-white rounded-lg shadow-lg px-3 py-2 text-sm font-semibold text-gray-700 whitespace-nowrap"
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: 10 }}
          >
            {message}
            <div className="absolute bottom-0 right-4 transform translate-y-1/2 rotate-45 w-3 h-3 bg-white" />
          </motion.div>
        )}
      </AnimatePresence>

      {/* Character sprite */}
      <motion.img
        key={characterState}
        src={characterImage}
        alt="Story character"
        className="w-20 h-20 md:w-32 md:h-32 drop-shadow-lg"
        initial={{ scale: 0.8 }}
        animate={{ scale: 1 }}
        transition={{ type: 'spring' }}
      />
    </motion.div>
  )
}
```

**ProgressIndicator Component:**
```typescript
'use client'

import { motion } from 'framer-motion'

interface ProgressIndicatorProps {
  gamesCompleted: number
  gamesUntilNextCheckpoint: number
  nextCheckpointTitle: string
}

export function ProgressIndicator({
  gamesCompleted,
  gamesUntilNextCheckpoint,
  nextCheckpointTitle
}: ProgressIndicatorProps) {
  const totalGames = gamesCompleted + gamesUntilNextCheckpoint
  const progress = (gamesCompleted / totalGames) * 100

  return (
    <div className="flex items-center gap-2">
      {/* Progress bar */}
      <div className="w-32 md:w-48 h-2 bg-white/30 rounded-full overflow-hidden">
        <motion.div
          className="h-full bg-yellow-400"
          initial={{ width: 0 }}
          animate={{ width: `${progress}%` }}
          transition={{ type: 'spring' }}
        />
      </div>

      {/* Text */}
      <div className="hidden md:block text-xs text-white/90 font-semibold whitespace-nowrap">
        {gamesUntilNextCheckpoint} games until {nextCheckpointTitle}
      </div>

      {/* Mobile: Just show count */}
      <div className="md:hidden text-xs text-white/90 font-semibold">
        {gamesCompleted}/{totalGames}
      </div>
    </div>
  )
}
```

**StoryUIContainer Component:**
```typescript
'use client'

import { StoryBanner } from './StoryBanner'
import { CharacterWidget } from './CharacterWidget'
import { ProgressIndicator } from './ProgressIndicator'
import { useStoryProgress } from '@/hooks/useStoryProgress'
import { useState } from 'react'

interface StoryUIContainerProps {
  theme: string
  children: React.ReactNode
}

export function StoryUIContainer({ theme, children }: StoryUIContainerProps) {
  const { currentCheckpoint, gamesCompleted, checkpointTitle } = useStoryProgress()
  const [characterState, setCharacterState] = useState<'neutral' | 'thinking' | 'celebrating'>('neutral')
  const [characterMessage, setCharacterMessage] = useState<string | undefined>()

  // Calculate progress
  const gamesPerCheckpoint = 5
  const gamesUntilNext = gamesPerCheckpoint - (gamesCompleted % gamesPerCheckpoint)

  return (
    <div className="relative min-h-screen">
      {/* Story Banner */}
      <StoryBanner
        theme={theme}
        currentCheckpoint={currentCheckpoint}
        checkpointTitle={checkpointTitle}
      />

      {/* Main game content */}
      <div className="pt-14 md:pt-16">
        {children}
      </div>

      {/* Character Widget */}
      <CharacterWidget
        theme={theme}
        characterState={characterState}
        message={characterMessage}
      />
    </div>
  )
}
```

**Theme Color Application:**
```typescript
// lib/story/theme-colors.ts
export const STORY_THEME_COLORS = {
  space: {
    primary: '#4A5FFF',
    secondary: '#FFB84D',
    accent: '#A78BFA',
    background: '#1E1B4B',
    text: '#F8FAFC'
  },
  treasure: {
    primary: '#D97706',
    secondary: '#FCD34D',
    accent: '#92400E',
    background: '#78350F',
    text: '#FFFBEB'
  },
  fantasy: {
    primary: '#7C3AED',
    secondary: '#EC4899',
    accent: '#10B981',
    background: '#581C87',
    text: '#FAE8FF'
  }
}

export function getThemeColors(theme: string) {
  return STORY_THEME_COLORS[theme] || STORY_THEME_COLORS.space
}

// Apply as CSS custom properties
export function applyThemeColors(theme: string) {
  const colors = getThemeColors(theme)
  document.documentElement.style.setProperty('--story-primary', colors.primary)
  document.documentElement.style.setProperty('--story-secondary', colors.secondary)
  document.documentElement.style.setProperty('--story-accent', colors.accent)
  document.documentElement.style.setProperty('--story-background', colors.background)
  document.documentElement.style.setProperty('--story-text', colors.text)
}
```

**Game Container with Story UI:**
```tsx
// app/game-session/page.tsx
export default function GameSessionPage() {
  const theme = 'space'

  return (
    <StoryUIContainer theme={theme}>
      <GameSessionController />
    </StoryUIContainer>
  )
}
```

### Dependencies

**Required:**
- Story 6.1 (Story Theme Assets) - Character sprites and icons
- Story 6.2 (Story Progress Machine) - Progress data
- `framer-motion` - Animations

**Enables:**
- Story 6.7 (Testing) - Will test story UI integration

### Testing

**Testing Framework:** Vitest + React Testing Library
**Test Locations:**
- `/components/story/StoryBanner.test.tsx`
- `/components/story/CharacterWidget.test.tsx`
- `/components/story/ProgressIndicator.test.tsx`
- `/components/story/StoryUIContainer.test.tsx`

**Test Scenarios:**
```typescript
describe('StoryBanner', () => {
  it('renders checkpoint info', () => {
    render(
      <StoryBanner
        theme="space"
        currentCheckpoint={1}
        checkpointTitle="Moon Landing"
      />
    )

    expect(screen.getByText('Moon Landing')).toBeInTheDocument()
    expect(screen.getByText(/Current Milestone/i)).toBeInTheDocument()
  })

  it('applies theme colors', () => {
    const { container } = render(
      <StoryBanner
        theme="space"
        currentCheckpoint={1}
        checkpointTitle="Moon Landing"
      />
    )

    const banner = container.firstChild as HTMLElement
    expect(banner.style.backgroundColor).toBeTruthy()
  })
})

describe('CharacterWidget', () => {
  it('renders character sprite', () => {
    render(
      <CharacterWidget
        theme="space"
        characterState="neutral"
      />
    )

    const img = screen.getByAlt('Story character')
    expect(img).toBeInTheDocument()
  })

  it('shows speech bubble when message provided', () => {
    render(
      <CharacterWidget
        theme="space"
        characterState="celebrating"
        message="Great job!"
      />
    )

    expect(screen.getByText('Great job!')).toBeInTheDocument()
  })
})

describe('ProgressIndicator', () => {
  it('displays progress correctly', () => {
    render(
      <ProgressIndicator
        gamesCompleted={3}
        gamesUntilNextCheckpoint={2}
        nextCheckpointTitle="Mars Mission"
      />
    )

    expect(screen.getByText(/2 games until Mars Mission/i)).toBeInTheDocument()
  })

  it('animates progress bar', () => {
    const { rerender } = render(
      <ProgressIndicator
        gamesCompleted={2}
        gamesUntilNextCheckpoint={3}
        nextCheckpointTitle="Mars"
      />
    )

    rerender(
      <ProgressIndicator
        gamesCompleted={3}
        gamesUntilNextCheckpoint={2}
        nextCheckpointTitle="Mars"
      />
    )

    // Progress bar should update
    // (Testing animation is tricky, mainly verify no errors)
  })
})
```

**Run Tests:**
```bash
npm run test
```

### Design Considerations

**Visual Hierarchy:**
1. **Primary**: Game content (70% visual weight)
2. **Secondary**: Story elements (30% visual weight)
3. Story UI enhances without overwhelming

**Performance:**
- Story elements: <50KB total assets
- Animations: 60fps on mid-range devices
- No layout shift when elements appear

**Accessibility:**
- Story elements don't interfere with game accessibility
- Can be hidden if needed
- Color contrast: WCAG AA compliant

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
