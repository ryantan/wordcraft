# Story 5.6: Test Game Variety and Balance

## Status

Draft

## Story

**As a** child and parent,
**I want** to ensure the game experience offers good variety and works smoothly across all game types,
**so that** practice stays engaging and effective.

## Acceptance Criteria

1. Integration tests verify all 8 games can be loaded and played successfully
2. Tests verify each game correctly implements the `GameMechanicProps` interface
3. Tests verify games handle difficulty levels appropriately
4. Tests verify touch and mouse interactions work for all games
5. Manual testing on mobile and desktop confirms responsive design
6. Tests verify game variety: no game appears >3 times in a 10-round session
7. Performance testing confirms all games load within 2 seconds
8. Accessibility testing confirms keyboard navigation works for all games

## Tasks / Subtasks

- [ ] Create comprehensive game interface tests (AC: 2)
  - [ ] Create test file `/__tests__/integration/game-interface-compliance.test.ts`
  - [ ] Test each game accepts `GameMechanicProps`:
    - `word: string`
    - `difficulty: 'easy' | 'medium' | 'hard'`
    - `onComplete: (result: GameResult) => void`
  - [ ] Test each game calls `onComplete` with valid `GameResult`
  - [ ] Verify `GameResult` structure for all games

- [ ] Create difficulty tests (AC: 3)
  - [ ] Test each game renders with easy difficulty
  - [ ] Test each game renders with medium difficulty
  - [ ] Test each game renders with hard difficulty
  - [ ] Verify difficulty affects game parameters correctly
  - [ ] Example: Easy has more hints, longer time limits

- [ ] Create interaction tests (AC: 4)
  - [ ] Test mouse interactions for all games:
    - Click events work
    - Drag and drop works (where applicable)
    - Hover states work
  - [ ] Test touch interactions:
    - Tap events work
    - Touch drag works
    - Multi-touch prevented (no pinch zoom)

- [ ] Create variety distribution tests (AC: 6)
  - [ ] Simulate 100 game sessions with 10 rounds each
  - [ ] Track game distribution
  - [ ] Verify no game appears >30% of time
  - [ ] Verify no game repeats consecutively
  - [ ] Verify all 8 games appear at least once in 50 rounds

- [ ] Create performance tests (AC: 7)
  - [ ] Measure initial load time for each game component
  - [ ] Measure render time for each game
  - [ ] Measure time to interactive
  - [ ] Verify all games load in <2 seconds
  - [ ] Test with throttled CPU/network

- [ ] Create responsive design tests (AC: 5)
  - [ ] Test each game at mobile size (375px width)
  - [ ] Test each game at tablet size (768px width)
  - [ ] Test each game at desktop size (1920px width)
  - [ ] Verify layouts adapt appropriately
  - [ ] Verify touch targets meet 44x44px minimum on mobile

- [ ] Create accessibility tests (AC: 8)
  - [ ] Test keyboard navigation for each game
  - [ ] Test screen reader compatibility
  - [ ] Test color contrast ratios (WCAG AA)
  - [ ] Test focus indicators visibility
  - [ ] Test ARIA labels and roles

- [ ] Manual testing checklist (AC: 5)
  - [ ] Test Letter Hunt on:
    - Chrome desktop
    - Safari mobile
    - Firefox desktop
  - [ ] Test Trace & Write on:
    - Touch screen device
    - Mouse device
    - Trackpad
  - [ ] Test Picture Reveal on:
    - Slow network (image loading)
    - High-res display
  - [ ] Test Word Building Blocks on:
    - Small screen mobile
    - Tablet portrait/landscape
  - [ ] Document any issues found

- [ ] Create game rotation tests
  - [ ] Simulate session with visual learner profile
  - [ ] Verify visual games appear more frequently
  - [ ] But still ensure variety (not only visual)
  - [ ] Simulate kinesthetic learner
  - [ ] Verify kinesthetic games favored
  - [ ] Test balanced profile gets balanced mix

- [ ] Create end-to-end game session test
  - [ ] Start session with word list
  - [ ] Play through 10 rounds
  - [ ] Verify mix of game types
  - [ ] Verify session completes successfully
  - [ ] Verify results saved correctly

- [ ] Performance benchmarking
  - [ ] Measure bundle size impact of all 8 games
  - [ ] Verify code splitting working (games loaded on demand)
  - [ ] Check for memory leaks during extended play
  - [ ] Verify smooth animations (60fps)

- [ ] Create test documentation
  - [ ] Document testing approach
  - [ ] List all test scenarios
  - [ ] Document browser compatibility matrix
  - [ ] Create testing checklist for QA

## Dev Notes

### Architecture Context

**Testing Strategy:**
[Source: docs/ui-architecture.md#Testing Strategy]

```
Test Pyramid for Epic 5:
        ┌────────────┐
        │    E2E     │  10% - Full game sessions
        ├────────────┤
        │Integration │  30% - Game interface, variety
        ├────────────┤
        │   Unit     │  60% - Component logic
        └────────────┘
```

**Game Interface Compliance Test:**
```typescript
import { describe, it, expect, vi } from 'vitest'
import { render, screen } from '@testing-library/react'
import { getAllGames } from '@/lib/games/registry'

describe('All Games Interface Compliance', () => {
  const games = getAllGames()

  games.forEach(({ Component, meta }) => {
    describe(`${meta.name} (${meta.id})`, () => {
      const mockProps = {
        word: 'test',
        difficulty: 'medium' as const,
        onComplete: vi.fn()
      }

      it('renders without crashing', () => {
        expect(() => render(<Component {...mockProps} />)).not.toThrow()
      })

      it('accepts all required props', () => {
        const { rerender } = render(<Component {...mockProps} />)

        // Test different difficulties
        rerender(<Component {...mockProps} difficulty="easy" />)
        rerender(<Component {...mockProps} difficulty="hard" />)

        // Should not crash
        expect(screen.getByRole('main')).toBeInTheDocument()
      })

      it('calls onComplete when game finishes', async () => {
        render(<Component {...mockProps} />)

        // Simulate game completion
        // (game-specific logic here)

        await waitFor(() => {
          expect(mockProps.onComplete).toHaveBeenCalledWith(
            expect.objectContaining({
              gameType: meta.id,
              isCorrect: expect.any(Boolean),
              attempts: expect.any(Number),
              timestamp: expect.any(Date)
            })
          )
        })
      })
    })
  })
})
```

**Game Variety Test:**
```typescript
describe('Game Variety Distribution', () => {
  it('ensures no game dominates sessions', () => {
    const sessions = 100
    const roundsPerSession = 10
    const gameCounts: Record<string, number> = {}

    for (let i = 0; i < sessions; i++) {
      const profile = { visual: 0.33, kinesthetic: 0.33, auditory: 0.34 }
      const history: string[] = []

      for (let round = 0; round < roundsPerSession; round++) {
        const game = selectGame('word', profile, 0.5, history)
        gameCounts[game] = (gameCounts[game] || 0) + 1
        history.push(game)
      }
    }

    const totalGames = sessions * roundsPerSession
    Object.entries(gameCounts).forEach(([gameId, count]) => {
      const percentage = (count / totalGames) * 100

      // No game should appear more than 30%
      expect(percentage).toBeLessThan(30)

      // All games should appear at least 5%
      expect(percentage).toBeGreaterThan(5)
    })
  })

  it('prevents consecutive game repetition', () => {
    for (let i = 0; i < 100; i++) {
      const profile = { visual: 0.5, kinesthetic: 0.3, auditory: 0.2 }
      const history = ['word-scramble', 'word-scramble']

      const nextGame = selectGame('word', profile, 0.5, history)

      expect(nextGame).not.toBe('word-scramble')
    }
  })
})
```

**Performance Test:**
```typescript
describe('Game Performance', () => {
  const games = getAllGames()

  games.forEach(({ Component, meta }) => {
    it(`${meta.name} loads within 2 seconds`, async () => {
      const startTime = performance.now()

      render(<Component word="test" difficulty="medium" onComplete={vi.fn()} />)

      await waitFor(() => {
        expect(screen.getByRole('main')).toBeInTheDocument()
      })

      const loadTime = performance.now() - startTime
      expect(loadTime).toBeLessThan(2000)
    })
  })
})
```

**Responsive Test:**
```typescript
describe('Responsive Design', () => {
  const breakpoints = {
    mobile: 375,
    tablet: 768,
    desktop: 1920
  }

  Object.entries(breakpoints).forEach(([device, width]) => {
    it(`all games render correctly on ${device}`, () => {
      global.innerWidth = width
      window.dispatchEvent(new Event('resize'))

      getAllGames().forEach(({ Component, meta }) => {
        const { container } = render(
          <Component word="test" difficulty="medium" onComplete={vi.fn()} />
        )

        // Verify game container fits within viewport
        const gameElement = container.firstChild as HTMLElement
        expect(gameElement.offsetWidth).toBeLessThanOrEqual(width)
      })
    })
  })
})
```

**Manual Testing Checklist:**
```markdown
## Manual Testing Checklist

### Letter Hunt
- [ ] Letters are clickable/tappable
- [ ] Scene is visible on all screen sizes
- [ ] Hint highlights correct letter
- [ ] Difficulty affects letter visibility
- [ ] Works on touch screen
- [ ] Works with mouse

### Trace & Write
- [ ] Canvas captures touch/mouse input
- [ ] Tracing path renders smoothly
- [ ] Validation provides appropriate feedback
- [ ] Works with stylus/pen
- [ ] Responsive on mobile
- [ ] Difficulty affects tolerance

### Picture Reveal
- [ ] Image loads correctly
- [ ] Blur/pixelation effect works
- [ ] Progressive reveal smooth
- [ ] Keyboard displays correctly
- [ ] Touch targets appropriate size
- [ ] Works on slow networks

### Word Building Blocks
- [ ] Drag and drop works (desktop)
- [ ] Tap-to-place works (mobile)
- [ ] Letters swap between slots
- [ ] Visual feedback clear
- [ ] Responsive layout
- [ ] Difficulty affects validation
```

### Dependencies

**Required:**
- Stories 5.1-5.5 - ALL must be complete
- Epic 3 games - For comparison and consistency

### Testing

**Testing Framework:** Vitest + React Testing Library + Playwright (E2E)
**Test Locations:**
- `/__tests__/integration/game-interface-compliance.test.ts`
- `/__tests__/integration/game-variety.test.ts`
- `/__tests__/e2e/all-games-playthrough.spec.ts`

**Run Tests:**
```bash
npm run test                  # Unit + integration
npm run test:e2e              # E2E tests
npm run test:all              # Full suite
npm run test:coverage         # With coverage
```

**Coverage Target:**
- Overall: >70%
- Game components: >65%
- Integration tests: 100% of critical paths

### Technical Constraints

- Performance: All games <2s load time
- Responsive: Works 375px to 1920px width
- Touch targets: Min 44x44px
- Animations: 60fps
- Accessibility: WCAG AA compliance

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
