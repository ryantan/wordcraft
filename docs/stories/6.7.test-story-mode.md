# Story 6.7: Test Story Mode Integration and Flow

## Status

Draft

## Story

**As a** developer,
**I want** to validate that story mode enhances rather than disrupts the gameplay experience,
**so that** children stay engaged and motivated.

## Acceptance Criteria

1. Integration tests verify story checkpoints trigger at correct intervals
2. Tests verify story state persists correctly across sessions
3. Manual play-testing confirms story feels motivating, not annoying
4. Testing confirms checkpoint screens don't break game flow
5. Story intro and finale appear at appropriate times
6. Visual elements render correctly on various screen sizes
7. Story content is age-appropriate and clear to target audience
8. User testing with children (if possible) validates engagement and understanding

## Tasks / Subtasks

- [ ] Create StoryProgressMachine tests (AC: 1)
  - [ ] Create test file `/machines/story-progress/storyProgressMachine.test.ts`
  - [ ] Test: Machine initializes in `intro` state
  - [ ] Test: Advances to checkpoint1 after 5 games
  - [ ] Test: Advances to checkpoint2 after 10 games
  - [ ] Test: Advances to checkpoint3 after 15 games
  - [ ] Test: Reaches finale when all words mastered
  - [ ] Test: Doesn't skip checkpoints
  - [ ] Test: CONTINUE_STORY transitions correctly
  - [ ] Run tests with `npm run test`

- [ ] Create checkpoint persistence tests (AC: 2)
  - [ ] Create test file `/__tests__/integration/story-persistence.test.ts`
  - [ ] Test: Checkpoint progress saved to IndexedDB
  - [ ] Test: Progress restored on page reload
  - [ ] Test: Checkpoint state matches before and after reload
  - [ ] Test: Multiple word lists have separate story progress
  - [ ] Test: Story resets when starting new word list
  - [ ] Mock IndexedDB for testing
  - [ ] Run tests with `npm run test`

- [ ] Create checkpoint timing tests (AC: 1, 4)
  - [ ] Create test file `/__tests__/integration/checkpoint-timing.test.ts`
  - [ ] Test: Checkpoint appears after exactly 5 games
  - [ ] Test: No checkpoint before 5 games
  - [ ] Test: Checkpoint doesn't appear twice in a row
  - [ ] Test: Skipping checkpoint allows game to continue
  - [ ] Test: Continue button delay works (5 seconds)
  - [ ] Test: Game flow smooth after checkpoint
  - [ ] Run tests with `npm run test`

- [ ] Create intro/finale trigger tests (AC: 5)
  - [ ] Create test file `/__tests__/integration/intro-finale-triggers.test.ts`
  - [ ] Test: Intro appears on first session with word list
  - [ ] Test: Intro doesn't appear on subsequent sessions
  - [ ] Test: Finale appears when all words >= 80% confidence
  - [ ] Test: Finale doesn't appear prematurely
  - [ ] Test: Finale shows correct stats
  - [ ] Test: Action buttons navigate correctly
  - [ ] Run tests with `npm run test`

- [ ] Create visual element rendering tests (AC: 6)
  - [ ] Create test file `/__tests__/integration/story-visual-elements.test.ts`
  - [ ] Test: StoryBanner renders on all screen sizes
  - [ ] Test: CharacterWidget positioned correctly on mobile
  - [ ] Test: ProgressIndicator scales appropriately
  - [ ] Test: Theme colors applied correctly
  - [ ] Test: Elements don't overlap with game content
  - [ ] Test: Responsive breakpoints work (375px, 768px, 1920px)
  - [ ] Run tests with `npm run test`

- [ ] Create end-to-end story flow test (AC: 4, 5)
  - [ ] Create test file `/__tests__/e2e/story-mode-flow.spec.ts`
  - [ ] Use Playwright for E2E testing
  - [ ] Test scenario: Complete story flow
    1. Start new word list
    2. See intro screen
    3. Click "Let's Begin"
    4. Play 5 games
    5. See checkpoint 1 screen
    6. Continue story
    7. Play 5 more games (total 10)
    8. See checkpoint 2 screen
    9. Continue story
    10. Play 5 more games (total 15)
    11. See checkpoint 3 screen
    12. Continue and master remaining words
    13. See finale screen
  - [ ] Verify each screen appears correctly
  - [ ] Verify transitions are smooth
  - [ ] Run with `npm run test:e2e`

- [ ] Create manual testing checklist (AC: 3, 7)
  - [ ] Create document `/docs/testing/story-mode-manual-tests.md`
  - [ ] Checklist items:
    - [ ] Story intro is engaging and clear
    - [ ] Checkpoint narratives are encouraging
    - [ ] Finale feels celebratory and rewarding
    - [ ] Story elements enhance gameplay (not distract)
    - [ ] Character widget is cute and non-intrusive
    - [ ] Progress indicator is clear and motivating
    - [ ] Theme visuals are cohesive
    - [ ] Text is readable for ages 5-10
    - [ ] Story enhances motivation to continue
    - [ ] No technical glitches or visual bugs
    - [ ] Mobile experience is good
    - [ ] Desktop experience is good
  - [ ] Conduct manual testing session
  - [ ] Document findings and issues

- [ ] Test content age-appropriateness (AC: 7)
  - [ ] Review all narrative content:
    - Intro text
    - Checkpoint 1, 2, 3 text
    - Finale text
  - [ ] Verify reading level appropriate (Grade 1-2)
  - [ ] Verify vocabulary is simple and clear
  - [ ] Verify tone is positive and encouraging
  - [ ] Verify content is gender-neutral
  - [ ] Verify content is culturally inclusive
  - [ ] Get feedback from educator or parent (if possible)

- [ ] Test game flow integration (AC: 4)
  - [ ] Manual test: Play through session noting timing
  - [ ] Verify checkpoint doesn't interrupt mid-game
  - [ ] Verify checkpoint appears after game completion
  - [ ] Verify transition delays feel natural
  - [ ] Verify "skip" option works without issues
  - [ ] Verify continuing after checkpoint resumes smoothly
  - [ ] Verify no state bugs (games continue correctly)

- [ ] Test story persistence scenarios (AC: 2)
  - [ ] Manual test: Interrupt session at various points
    - Close browser during intro
    - Close browser after checkpoint 1
    - Close browser during checkpoint screen
    - Close browser after finale
  - [ ] Reopen and verify:
    - Progress restored correctly
    - No duplicate checkpoints
    - Story continues from correct point
    - No data loss

- [ ] Create performance tests
  - [ ] Test: Story UI doesn't slow down games
  - [ ] Test: Animations maintain 60fps
  - [ ] Test: Asset loading doesn't block gameplay
  - [ ] Test: IndexedDB operations are fast (<100ms)
  - [ ] Test: Memory usage reasonable with story mode
  - [ ] Profile with Chrome DevTools
  - [ ] Optimize if issues found

- [ ] Test accessibility (AC: 6)
  - [ ] Keyboard navigation:
    - Can skip intro with Enter
    - Can continue checkpoint with Enter
    - Can navigate finale buttons with Tab
  - [ ] Screen reader compatibility:
    - Narrative text is read correctly
    - Story banner is announced
    - Progress indicator has text alternative
  - [ ] Color contrast:
    - All text meets WCAG AA (4.5:1)
    - Story elements visible against backgrounds
  - [ ] Use axe DevTools for automated checks
  - [ ] Manual testing with screen reader

- [ ] Conduct user testing (AC: 8)
  - [ ] **If possible**: Test with 2-3 children (ages 5-10)
  - [ ] Observe:
    - Do they understand the story?
    - Are they excited by checkpoints?
    - Do they find it motivating?
    - Do they skip or engage with story?
    - Any confusion or frustration?
  - [ ] Collect feedback from parents/guardians
  - [ ] Document observations
  - [ ] Adjust content/timing based on feedback

- [ ] Create browser compatibility tests
  - [ ] Test on Chrome (desktop & mobile)
  - [ ] Test on Safari (desktop & mobile)
  - [ ] Test on Firefox (desktop)
  - [ ] Test on Edge (desktop)
  - [ ] Verify:
    - Animations work smoothly
    - Confetti renders correctly
    - IndexedDB persistence works
    - Images load properly
    - No layout bugs
  - [ ] Document any browser-specific issues

- [ ] Create test data fixtures
  - [ ] Create `/tests/fixtures/story-test-data.ts`:
    ```typescript
    export const testWordList = {
      id: 'test-list-1',
      name: 'Test Words',
      words: ['cat', 'dog', 'run', 'jump', 'play', 'ball', 'tree', 'sun', 'moon', 'star']
    }

    export const mockStoryProgress = {
      currentCheckpoint: 1,
      gamesCompleted: 5,
      checkpointsUnlocked: [0, 1],
      storyTheme: 'space'
    }

    export const mockSessionStats = {
      wordsMastered: 10,
      gamesPlayed: 25,
      timeSpent: 1200,
      totalWords: 10
    }
    ```
  - [ ] Use fixtures in all tests for consistency

- [ ] Create regression test suite
  - [ ] Test: Story doesn't break existing game functionality
  - [ ] Test: Games still work without story mode
  - [ ] Test: Adaptive engine still works with story
  - [ ] Test: Word lists still work with story
  - [ ] Test: Dashboard shows story progress correctly
  - [ ] Run full test suite before release

- [ ] Document testing results
  - [ ] Create `/docs/testing/story-mode-test-results.md`
  - [ ] Summary of unit test results (coverage %)
  - [ ] Summary of integration test results
  - [ ] Summary of E2E test results
  - [ ] Summary of manual testing findings
  - [ ] Summary of user testing (if conducted)
  - [ ] Known issues and workarounds
  - [ ] Recommendations for improvements

## Dev Notes

### Architecture Context

**Testing Strategy Overview:**
[Source: docs/ui-architecture.md#Testing Strategy]

```
Story Mode Testing Pyramid:
        ┌─────────────┐
        │     E2E     │  10% - Full story flow
        ├─────────────┤
        │ Integration │  30% - Machine integration, persistence
        ├─────────────┤
        │    Unit     │  60% - Component logic, content
        └─────────────┘
```

**StoryProgressMachine Test Examples:**
```typescript
import { describe, it, expect } from 'vitest'
import { createActor } from 'xstate'
import { storyProgressMachine } from './storyProgressMachine'

describe('StoryProgressMachine', () => {
  it('starts in intro state', () => {
    const actor = createActor(storyProgressMachine)
    actor.start()

    expect(actor.getSnapshot().matches('intro')).toBe(true)
    expect(actor.getSnapshot().context.gamesCompleted).toBe(0)
    expect(actor.getSnapshot().context.currentCheckpoint).toBe(0)
  })

  it('transitions to playing after CONTINUE_STORY', () => {
    const actor = createActor(storyProgressMachine)
    actor.start()

    actor.send({ type: 'CONTINUE_STORY' })

    expect(actor.getSnapshot().matches('playing')).toBe(true)
  })

  it('reaches checkpoint1 after 5 games', () => {
    const actor = createActor(storyProgressMachine)
    actor.start()

    actor.send({ type: 'CONTINUE_STORY' })

    // Complete 5 games
    for (let i = 0; i < 5; i++) {
      actor.send({ type: 'GAME_COMPLETED' })
    }

    expect(actor.getSnapshot().matches('checkpoint1')).toBe(true)
    expect(actor.getSnapshot().context.currentCheckpoint).toBe(1)
    expect(actor.getSnapshot().context.gamesCompleted).toBe(5)
  })

  it('reaches checkpoint2 after 10 games', () => {
    const actor = createActor(storyProgressMachine)
    actor.start()

    actor.send({ type: 'CONTINUE_STORY' })

    for (let i = 0; i < 10; i++) {
      actor.send({ type: 'GAME_COMPLETED' })
      if (i === 4 || i === 9) {
        actor.send({ type: 'CONTINUE_STORY' }) // Continue past checkpoints
      }
    }

    expect(actor.getSnapshot().matches('checkpoint2')).toBe(true)
    expect(actor.getSnapshot().context.currentCheckpoint).toBe(2)
  })

  it('doesn\'t skip checkpoints', () => {
    const actor = createActor(storyProgressMachine)
    actor.start()

    actor.send({ type: 'CONTINUE_STORY' })

    // Jump to 10 games (shouldn't skip checkpoint1)
    for (let i = 0; i < 10; i++) {
      actor.send({ type: 'GAME_COMPLETED' })
    }

    // Should still hit checkpoint1 first
    expect(actor.getSnapshot().matches('checkpoint1')).toBe(true)
  })
})
```

**Persistence Test Examples:**
```typescript
import { describe, it, expect, beforeEach, afterEach } from 'vitest'
import { createActor } from 'xstate'
import { storyProgressMachine } from '@/machines/story-progress/storyProgressMachine'
import { saveStoryProgress, loadStoryProgress } from '@/lib/storage/story-progress-storage'

describe('Story Persistence', () => {
  beforeEach(async () => {
    // Clear IndexedDB before each test
    await clearStoryProgressDB()
  })

  afterEach(async () => {
    await clearStoryProgressDB()
  })

  it('saves progress to IndexedDB', async () => {
    const actor = createActor(storyProgressMachine)
    actor.start()

    actor.send({ type: 'CONTINUE_STORY' })
    actor.send({ type: 'GAME_COMPLETED' })

    // Wait for persistence
    await new Promise(resolve => setTimeout(resolve, 100))

    const saved = await loadStoryProgress()
    expect(saved?.gamesCompleted).toBe(1)
  })

  it('restores progress from IndexedDB', async () => {
    // Save some progress
    await saveStoryProgress({
      currentCheckpoint: 1,
      gamesCompleted: 7,
      checkpointsUnlocked: [0, 1],
      storyTheme: 'space'
    })

    // Create new machine instance (simulating page reload)
    const actor = createActor(storyProgressMachine)
    actor.start()

    // Machine should restore state
    const snapshot = actor.getSnapshot()
    expect(snapshot.context.gamesCompleted).toBe(7)
    expect(snapshot.context.currentCheckpoint).toBe(1)
  })

  it('handles multiple word lists separately', async () => {
    const list1Progress = {
      wordListId: 'list-1',
      currentCheckpoint: 1,
      gamesCompleted: 5
    }

    const list2Progress = {
      wordListId: 'list-2',
      currentCheckpoint: 0,
      gamesCompleted: 2
    }

    await saveStoryProgress(list1Progress)
    await saveStoryProgress(list2Progress)

    const loaded1 = await loadStoryProgress('list-1')
    const loaded2 = await loadStoryProgress('list-2')

    expect(loaded1?.gamesCompleted).toBe(5)
    expect(loaded2?.gamesCompleted).toBe(2)
  })
})
```

**E2E Test Example (Playwright):**
```typescript
import { test, expect } from '@playwright/test'

test.describe('Story Mode Flow', () => {
  test('complete story from intro to finale', async ({ page }) => {
    await page.goto('/word-lists')

    // Create new word list
    await page.click('text=Create New List')
    await page.fill('input[name="listName"]', 'Story Test Words')
    await page.fill('textarea[name="words"]', 'cat,dog,run,jump,play,ball,tree,sun,moon,star')
    await page.click('text=Create List')

    // Start game session
    await page.click('text=Play Games')

    // Should see intro screen
    await expect(page.locator('text=Begin Your Journey')).toBeVisible()
    await page.click('text=Let\'s Begin!')

    // Play 5 games to reach checkpoint 1
    for (let i = 0; i < 5; i++) {
      // Complete game (game-specific actions here)
      await page.click('[data-testid="complete-game"]')
    }

    // Should see checkpoint 1
    await expect(page.locator('text=Moon Landing')).toBeVisible()
    await page.waitForTimeout(5000) // Wait for continue button
    await page.click('text=Continue Adventure')

    // Play 5 more games to reach checkpoint 2
    for (let i = 0; i < 5; i++) {
      await page.click('[data-testid="complete-game"]')
    }

    // Should see checkpoint 2
    await expect(page.locator('text=Mars Mission')).toBeVisible()
    await page.click('text=Continue Adventure')

    // Continue until finale
    // (simplified - would need to master all words)

    // Verify finale appears
    await expect(page.locator('text=Mission Complete')).toBeVisible()
    await expect(page.locator('text=10')).toBeVisible() // Words mastered
  })

  test('story persists across sessions', async ({ page }) => {
    await page.goto('/game-session')

    // Play 3 games
    for (let i = 0; i < 3; i++) {
      await page.click('[data-testid="complete-game"]')
    }

    // Reload page
    await page.reload()

    // Verify progress indicator shows 3 games
    await expect(page.locator('text=3/5')).toBeVisible()
  })

  test('can skip checkpoints', async ({ page }) => {
    await page.goto('/game-session')

    // Get to checkpoint
    for (let i = 0; i < 5; i++) {
      await page.click('[data-testid="complete-game"]')
    }

    // Skip checkpoint
    await page.click('text=Skip')

    // Should be back in game
    await expect(page.locator('[data-testid="game-container"]')).toBeVisible()
  })
})
```

**Manual Testing Checklist:**
```markdown
# Story Mode Manual Testing Checklist

## Story Intro
- [ ] Intro appears when starting new word list
- [ ] Intro doesn't appear on returning to same list
- [ ] Character sprite loads correctly
- [ ] Background image loads correctly
- [ ] Narrative text is clear and readable
- [ ] "Let's Begin" button works
- [ ] Animation is smooth
- [ ] Mobile layout looks good
- [ ] Desktop layout looks good

## Checkpoints
- [ ] Checkpoint 1 appears after exactly 5 games
- [ ] Checkpoint 2 appears after exactly 10 games
- [ ] Checkpoint 3 appears after exactly 15 games
- [ ] Checkpoint screens don't interrupt mid-game
- [ ] Continue button disabled for 5 seconds
- [ ] Continue button works after delay
- [ ] Skip button works immediately
- [ ] Confetti animation plays
- [ ] Character celebration sprite displays
- [ ] Narrative text is encouraging
- [ ] Transitions are smooth

## Story Finale
- [ ] Finale appears when all words mastered
- [ ] Stats display correctly (words, games, time)
- [ ] Character celebration sprite displays
- [ ] Trophy/badge displays
- [ ] Confetti animation plays
- [ ] "Practice More" button works
- [ ] "Try New Words" button navigates correctly
- [ ] "View Progress" button navigates correctly
- [ ] Count-up animation smooth

## Visual Elements During Gameplay
- [ ] Story banner displays correctly
- [ ] Character widget displays in corner
- [ ] Progress indicator shows correct progress
- [ ] Theme colors applied correctly
- [ ] Elements don't block game content
- [ ] Elements are visible but not distracting
- [ ] Mobile layout appropriate
- [ ] Desktop layout appropriate

## Persistence
- [ ] Progress saved when closing browser
- [ ] Progress restored on reopening
- [ ] Multiple word lists tracked separately
- [ ] No duplicate checkpoints after reload

## Overall Experience
- [ ] Story feels motivating
- [ ] Story doesn't feel annoying or intrusive
- [ ] Flow is smooth and natural
- [ ] No technical bugs encountered
- [ ] Experience is enjoyable for target age (5-10)
```

### Dependencies

**Required:**
- All stories 6.1-6.6 - MUST be complete for full testing
- Vitest - Unit and integration testing
- Playwright - E2E testing
- React Testing Library - Component testing

**Testing Tools:**
```bash
npm install -D @playwright/test
npm install -D @testing-library/react
npm install -D @testing-library/user-event
npm install -D fake-indexeddb  # For IndexedDB mocking
```

### Testing

**Test Execution Plan:**

1. **Unit Tests** (Stories 6.1-6.6 individual tests)
   ```bash
   npm run test
   ```

2. **Integration Tests** (This story)
   ```bash
   npm run test -- --grep="integration"
   ```

3. **E2E Tests** (This story)
   ```bash
   npm run test:e2e
   ```

4. **Manual Testing** (Checklist above)
   - Execute checklist items
   - Document findings
   - File issues for bugs

5. **User Testing** (If possible)
   - Arrange session with 2-3 children
   - Observe and document
   - Collect feedback

**Coverage Targets:**
- Unit tests: >80% coverage
- Integration tests: 100% of critical paths
- E2E tests: Full happy path + error scenarios
- Manual testing: All checklist items verified

**Run All Tests:**
```bash
npm run test:all
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
