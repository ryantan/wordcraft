# Story 4.1: Implement Confidence Scoring Algorithm

## Status

Implemented ✅

**Completion Date:** Pre-existing (before Epic 6 story creation)
**Implementation:** `/lib/algorithms/confidence-scoring.ts`

## Story

**As a** developer,
**I want** to build an algorithm that calculates a confidence score (0-100%) for each word based on game results,
**so that** the system can identify which words need more practice.

## Acceptance Criteria

1. A `/lib/algorithms/confidence-scoring.ts` module is created
2. Algorithm calculates confidence based on: accuracy rate, number of attempts, recency of practice
3. Formula gives more weight to recent attempts than older ones (recency bias)
4. Confidence increases with consecutive correct answers, decreases with incorrect answers
5. Thresholds are defined: <60% = needs work, 60-80% = progressing, >80% = mastered
6. Algorithm handles edge cases (new words with no history, perfect scores, etc.)
7. Unit tests verify confidence calculations for various scenarios
8. Algorithm is documented with comments explaining the scoring logic

## Tasks / Subtasks

- [ ] Create confidence scoring algorithm module (AC: 1, 2, 3, 4)
  - [ ] Create file `/lib/algorithms/confidence-scoring.ts`
  - [ ] Define the `calculateConfidence` function signature accepting word and game results
  - [ ] Implement accuracy rate calculation (correct attempts / total attempts)
  - [ ] Implement recency bias using exponential decay formula for older results
  - [ ] Implement consecutive success/failure tracking
  - [ ] Combine metrics into final confidence score (0-100%)
  - [ ] Add inline documentation explaining the scoring formula

- [ ] Define confidence threshold constants (AC: 5)
  - [ ] Create constants: NEEDS_WORK (< 60%), PROGRESSING (60-80%), MASTERED (> 80%)
  - [ ] Export helper function `getConfidenceLevel(score)` that returns the threshold category

- [ ] Handle edge cases (AC: 6)
  - [ ] Handle case: word with zero game results (return 0% confidence)
  - [ ] Handle case: word with only 1-2 results (prevent premature "mastered" status)
  - [ ] Handle case: perfect 100% score across multiple attempts
  - [ ] Handle case: invalid/corrupted game result data

- [ ] Create comprehensive unit tests (AC: 7)
  - [ ] Create test file `/lib/algorithms/confidence-scoring.test.ts`
  - [ ] Test: new word with no history returns 0% confidence
  - [ ] Test: 100% accuracy over 5+ attempts returns high confidence (>80%)
  - [ ] Test: 50% accuracy returns moderate confidence (~50-60%)
  - [ ] Test: recent success after older failures increases confidence
  - [ ] Test: recent failure after older successes decreases confidence
  - [ ] Test: consecutive correct answers boost confidence faster
  - [ ] Test: edge cases (empty data, single result, perfect scores)
  - [ ] Run tests with `npm run test` to verify all pass

- [ ] Define TypeScript types (AC: 8)
  - [ ] Verify `GameResult` type exists in `/types/game.ts` or create it
  - [ ] Verify `ConfidenceScore` type exists or define it with score and level properties
  - [ ] Ensure all function parameters and return values are properly typed

## Dev Notes

### Architecture Context

**File Structure:**
[Source: docs/ui-architecture.md#Project Structure]
- Algorithm implementation: `/lib/algorithms/confidence-scoring.ts`
- Unit tests: `/lib/algorithms/confidence-scoring.test.ts`
- Type definitions: `/types/game.ts`

**Data Models:**
[Source: docs/ui-architecture.md#AdaptiveEngineMachine]
```typescript
interface ConfidenceScore {
  word: string
  score: number // 0-100
  level: 'needs-work' | 'progressing' | 'mastered'
  lastUpdated: Date
}

interface GameResult {
  wordId: string
  gameType: string
  isCorrect: boolean
  attempts: number
  timestamp: Date
  timeTaken?: number
}
```

**Algorithm Requirements:**
[Source: docs/prd.md#Epic 4 - Story 4.1]
The confidence scoring algorithm should:
1. **Accuracy Rate**: Calculate the percentage of correct attempts
2. **Recency Bias**: Give more weight to recent game results (exponential decay)
3. **Consecutive Performance**: Track streaks of correct/incorrect answers
4. **Edge Case Handling**: Handle new words, single attempts, perfect scores

**Confidence Thresholds:**
- **< 60%**: Needs Work - Word should be prioritized for practice
- **60-80%**: Progressing - Word is being learned, continue regular practice
- **> 80%**: Mastered - Word is well-learned, reduce practice frequency

**Example Formula (suggested approach):**
```typescript
// Weighted average with recency bias
confidenceScore = (
  accuracyRate * 0.5 +           // 50% weight on overall accuracy
  recentAccuracy * 0.3 +          // 30% weight on last 5 attempts
  consecutiveBonus * 0.2          // 20% weight on streaks
) * 100

// Apply exponential decay for recency
weight(result, index) = Math.exp(-0.1 * index)
```

### Testing

[Source: docs/ui-architecture.md#Testing Strategy]

**Testing Framework:** Vitest
**Test Location:** `/lib/algorithms/confidence-scoring.test.ts`
**Coverage Target:** 70%+ for algorithm functions

**Test Setup:**
```typescript
import { describe, it, expect } from 'vitest'
import { calculateConfidence } from './confidence-scoring'
import type { GameResult } from '@/types/game'
```

**Test Scenarios:**
1. Empty history (new word) → 0% confidence
2. Perfect accuracy (5+ correct) → >80% confidence
3. Mixed results (3 correct, 2 wrong) → ~60% confidence
4. Recency bias: Recent success overrides old failures
5. Consecutive streaks increase confidence faster
6. Edge cases: null data, single result, corrupted data

**Run Tests:**
```bash
npm run test              # Run all tests in watch mode
npm run test:coverage     # Generate coverage report
```

### Previous Story Insights

No previous stories in Epic 4. This is the foundational algorithm for the Adaptive Learning Engine.

### Technical Constraints

- Pure function: No side effects, fully testable
- TypeScript strict mode: All types must be explicitly defined
- Performance: Algorithm should execute in < 10ms even with 100+ game results
- Immutable: Do not mutate input game results array

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5 (status verification on 2025-10-20)

### Debug Log References

N/A - Pre-existing implementation

### Completion Notes List

**Implementation Status:**
- ✅ Fully implemented with weighted average algorithm
- ✅ Exponential decay for recency bias (0.7 decay factor)
- ✅ Performance scoring includes: correctness, attempts, hints, time
- ✅ Thresholds defined: <60% needs work, 60-80% progressing, >80% mastered
- ✅ Edge cases handled (no history, perfect scores)
- ✅ Used in SessionSummary and Dashboard components
- ❌ Unit tests not implemented

**Integration Points:**
- `components/game/SessionSummary.tsx` - Displays confidence scores
- `app/dashboard/page.tsx` - Shows word mastery overview
- `lib/game/useGameSession.ts` - Tracks performance data

### File List

**Primary Implementation:**
- `/lib/algorithms/confidence-scoring.ts` (180 lines)

**Usage Locations:**
- `/components/game/SessionSummary.tsx`
- `/app/dashboard/page.tsx`

## QA Results

_To be populated by QA agent_
