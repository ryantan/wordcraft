# Story 5.2: Implement Trace & Write Game

## Status

Draft

## Story

**As a** child,
**I want** to trace letter shapes with my finger or mouse to form a word,
**so that** I can practice spelling through kinesthetic motor memory.

## Acceptance Criteria

1. `TraceAndWrite` component is created in `/components/games/TraceAndWrite.tsx`
2. Component implements the `GameMechanicProps` interface
3. Component displays outlined letters for the target word
4. User traces each letter path with touch/mouse; system validates tracing accuracy
5. Tracing path follows proper letter formation (top-to-bottom, left-to-right)
6. Visual feedback shows tracing progress (path fills in as user traces)
7. Letter advances to next when tracing is complete (>80% accuracy)
8. Game tracks attempts, time taken, accuracy percentage
9. Component is categorized as kinesthetic learning style
10. Component supports difficulty: easy (thick lines, forgiving), medium (normal), hard (thin lines, strict)

## Tasks / Subtasks

- [ ] Create TraceAndWrite component (AC: 1, 2)
  - [ ] Create file `/components/games/TraceAndWrite.tsx`
  - [ ] Implement `GameMechanicProps` interface
  - [ ] Setup component state: current letter index, tracing progress, attempts

- [ ] Implement letter tracing canvas (AC: 3, 4)
  - [ ] Use HTML5 Canvas or SVG for tracing
  - [ ] Display letter outline (dotted or gray line)
  - [ ] Show starting point indicator (green dot or arrow)
  - [ ] Capture mouse/touch movements
  - [ ] Track user's tracing path coordinates

- [ ] Generate letter path data (AC: 5)
  - [ ] Define proper stroke order for each letter A-Z
  - [ ] Use standard handwriting guidelines:
    - Top-to-bottom strokes
    - Left-to-right strokes
    - Clockwise circles (O, C)
  - [ ] Store as SVG paths or coordinate arrays
  - [ ] Support both uppercase and lowercase

- [ ] Implement tracing validation (AC: 4, 7)
  - [ ] Compare user's path to target letter path
  - [ ] Calculate accuracy: percentage of path correctly traced
  - [ ] Allow tolerance based on difficulty:
    - Easy: 60% accuracy required
    - Medium: 75% accuracy required
    - Hard: 85% accuracy required
  - [ ] Advance to next letter when threshold met

- [ ] Add visual feedback (AC: 6)
  - [ ] Show traced path in real-time (green color)
  - [ ] Show incorrect sections (red highlight)
  - [ ] Fill letter outline as user traces
  - [ ] Animate checkmark when letter completed
  - [ ] Show progress bar for current letter

- [ ] Implement difficulty variations (AC: 10)
  - [ ] **Easy**:
    - Thick tracing path (30px tolerance)
    - Starting point highlighted
    - Directional arrows shown
    - Allow multiple attempts per letter
  - [ ] **Medium**:
    - Normal tracing path (20px tolerance)
    - Starting point shown
    - No directional guides
    - 2 attempts per letter
  - [ ] **Hard**:
    - Thin tracing path (10px tolerance)
    - No guides
    - Must follow proper stroke order
    - 1 attempt per letter

- [ ] Track game metrics (AC: 8)
  - [ ] Track attempts per letter
  - [ ] Track total time
  - [ ] Calculate average accuracy percentage
  - [ ] Create `GameResult` on completion

- [ ] Handle touch and mouse input
  - [ ] Support mouse drag for desktop
  - [ ] Support touch events for mobile/tablets
  - [ ] Detect pen/stylus input (higher precision)
  - [ ] Prevent default touch behaviors (scrolling, zooming)

- [ ] Add animations and feedback
  - [ ] Sparkle effect along traced path
  - [ ] Completion celebration per letter
  - [ ] Wrong direction gentle shake
  - [ ] Final word reveal animation

- [ ] Update game mechanic registration (AC: 9)
  - [ ] Verify `/lib/games/trace-write.ts` metadata
  - [ ] Update: `learningStyle: ['kinesthetic']`
  - [ ] Register in game registry

- [ ] Create component tests
  - [ ] Create test file `/components/games/TraceAndWrite.test.tsx`
  - [ ] Test: Component renders letter outlines
  - [ ] Test: Touch/mouse input captured
  - [ ] Test: Accuracy validation works
  - [ ] Test: Advances to next letter on completion
  - [ ] Test: Difficulty affects tolerance
  - [ ] Run tests with `npm run test`

## Dev Notes

### Architecture Context

**File Structure:**
```
components/
├── games/
│   ├── TraceAndWrite.tsx
│   ├── TraceAndWrite.test.tsx
│   └── letter-paths/           # SVG path data for letters
│       └── letterPaths.ts
```

**Letter Path Data:**
```typescript
// letter-paths/letterPaths.ts
export const LETTER_PATHS = {
  A: {
    strokes: [
      { points: [[x1, y1], [x2, y2], ...], direction: 'down-right' },
      { points: [[x1, y1], [x2, y2], ...], direction: 'down-left' },
      { points: [[x1, y1], [x2, y2], ...], direction: 'right' }
    ],
    bounds: { width: 100, height: 120 }
  },
  // ... other letters
}
```

**Tracing Validation Algorithm:**
```typescript
function validateTracing(
  userPath: Point[],
  targetPath: Point[],
  tolerance: number
): { accuracy: number; isValid: boolean } {
  let matchedPoints = 0

  for (const userPoint of userPath) {
    const closestDistance = getClosestPointDistance(userPoint, targetPath)

    if (closestDistance <= tolerance) {
      matchedPoints++
    }
  }

  const accuracy = (matchedPoints / userPath.length) * 100
  const threshold = getDifficultyThreshold(difficulty)

  return {
    accuracy,
    isValid: accuracy >= threshold
  }
}
```

**Canvas Implementation Example:**
```typescript
'use client'

import { useRef, useState, useEffect } from 'react'
import type { GameMechanicProps } from '@/types'

export function TraceAndWrite({ word, difficulty, onComplete }: GameMechanicProps) {
  const canvasRef = useRef<HTMLCanvasElement>(null)
  const [currentLetterIndex, setCurrentLetterIndex] = useState(0)
  const [tracing, setTracing] = useState(false)
  const [userPath, setUserPath] = useState<Point[]>([])

  const letters = word.toUpperCase().split('')
  const currentLetter = letters[currentLetterIndex]

  const handlePointerDown = (e: React.PointerEvent) => {
    setTracing(true)
    setUserPath([getPointerPosition(e)])
  }

  const handlePointerMove = (e: React.PointerEvent) => {
    if (!tracing) return

    const newPath = [...userPath, getPointerPosition(e)]
    setUserPath(newPath)

    // Draw traced path on canvas
    drawPath(newPath)
  }

  const handlePointerUp = () => {
    setTracing(false)

    // Validate traced letter
    const { accuracy, isValid } = validateTracing(
      userPath,
      LETTER_PATHS[currentLetter],
      getDifficultyTolerance(difficulty)
    )

    if (isValid) {
      // Move to next letter
      if (currentLetterIndex < letters.length - 1) {
        setCurrentLetterIndex(prev => prev + 1)
        setUserPath([])
      } else {
        completeGame()
      }
    } else {
      // Allow retry
      setUserPath([])
    }
  }

  return (
    <div className="trace-write-container">
      <div className="word-display">
        {letters.map((letter, idx) => (
          <span key={idx} className={idx < currentLetterIndex ? 'completed' : ''}>
            {letter}
          </span>
        ))}
      </div>

      <canvas
        ref={canvasRef}
        width={400}
        height={500}
        onPointerDown={handlePointerDown}
        onPointerMove={handlePointerMove}
        onPointerUp={handlePointerUp}
        style={{ touchAction: 'none' }}
      />

      <div className="instructions">
        Trace the letter {currentLetter}
      </div>
    </div>
  )
}
```

**Accessibility Considerations:**
- Support keyboard for users who can't trace
- Provide alternative "tap letter tiles" mode
- High contrast letter outlines
- Adjustable tolerance for motor skill differences

### Dependencies

**Required:**
- Epic 3 games - Provides GameMechanicProps pattern
- HTML5 Canvas or React libraries like react-canvas-draw

**Optional Libraries:**
- `perfect-freehand` - For smooth path rendering
- `react-signature-canvas` - Alternative canvas implementation

### Testing

**Testing Framework:** Vitest + React Testing Library
**Test Location:** `/components/games/TraceAndWrite.test.tsx`
**Coverage Target:** 70%+

**Test Scenarios:**
```typescript
describe('TraceAndWrite Game', () => {
  it('renders letter outline to trace', () => {
    render(<TraceAndWrite word="cat" difficulty="easy" onComplete={vi.fn()} />)

    expect(screen.getByText('Trace the letter C')).toBeInTheDocument()
  })

  it('validates tracing accuracy', () => {
    const { container } = render(<TraceAndWrite word="a" difficulty="medium" onComplete={vi.fn()} />)

    const canvas = container.querySelector('canvas')
    // Simulate tracing events
    fireEvent.pointerDown(canvas, { clientX: 50, clientY: 50 })
    fireEvent.pointerMove(canvas, { clientX: 60, clientY: 70 })
    fireEvent.pointerUp(canvas)

    // Assert validation occurred
  })
})
```

**Run Tests:**
```bash
npm run test
```

### Technical Constraints

- Touch precision: Account for finger size (20-30px tolerance)
- Performance: Canvas rendering at 60fps
- Pointer events: Use PointerEvent API for unified touch/mouse
- No scroll: Prevent default touch behaviors during tracing
- Letter database: Provide accurate stroke order data

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
