# Story 4.3: Implement Spaced Repetition Logic

## Status

Draft

## Story

**As a** developer,
**I want** to implement a spaced repetition algorithm that determines when to re-introduce words,
**so that** challenging words are practiced at optimal intervals for retention.

## Acceptance Criteria

1. A `/lib/algorithms/spaced-repetition.ts` module implements Leitner system or SM-2 algorithm
2. Algorithm tracks per-word: review count, last review date, current interval
3. Words with low confidence are scheduled for sooner review
4. Words with high confidence have longer intervals between reviews
5. Algorithm provides `getNextWords()` function that prioritizes words due for review
6. Within-session logic re-introduces struggling words 2-3 times per session
7. Cross-session logic schedules words for future sessions based on mastery
8. Unit tests verify spacing intervals and word prioritization

## Tasks / Subtasks

- [ ] Create spaced repetition algorithm module (AC: 1)
  - [ ] Create file `/lib/algorithms/spaced-repetition.ts`
  - [ ] Research Leitner system basics (3-5 boxes with increasing intervals)
  - [ ] Decide between Leitner system vs SM-2 algorithm (recommend Leitner for simplicity)
  - [ ] Document chosen algorithm and rationale in code comments

- [ ] Define spaced repetition data structures (AC: 2)
  - [ ] Create `ReviewSchedule` type in `/types/game.ts`:
    - `wordId: string`
    - `reviewCount: number`
    - `lastReviewDate: Date`
    - `currentBox: number` (for Leitner: 1-5)
    - `nextReviewDate: Date`
    - `confidenceScore: number`
  - [ ] Create helper functions to initialize new word schedules

- [ ] Implement Leitner box system (AC: 3, 4)
  - [ ] Define box intervals: Box 1 (same session), Box 2 (1 day), Box 3 (3 days), Box 4 (7 days), Box 5 (14+ days)
  - [ ] Implement `promoteWord(schedule)` - move to next box on correct answer
  - [ ] Implement `demoteWord(schedule)` - move back to Box 1 on incorrect answer
  - [ ] Calculate `nextReviewDate` based on current box interval
  - [ ] Integrate with confidence scores from Story 4.1

- [ ] Implement within-session logic (AC: 6)
  - [ ] Create `getWordsForSession(wordList, sessionLength)` function
  - [ ] Prioritize Box 1 words (need immediate practice)
  - [ ] Re-introduce struggling words (confidence < 60%) 2-3 times
  - [ ] Include mix of new words and review words
  - [ ] Limit session length to prevent overwhelm (e.g., 10-15 words max)

- [ ] Implement cross-session scheduling (AC: 5, 7)
  - [ ] Create `getNextWords(allSchedules, maxWords)` function
  - [ ] Filter words where `nextReviewDate <= today`
  - [ ] Sort by: Box number (lowest first), then by `lastReviewDate` (oldest first)
  - [ ] Return top N words due for review
  - [ ] Handle case where no words are due (all mastered)

- [ ] Integrate with confidence scoring (AC: 3, 4)
  - [ ] Import `ConfidenceScore` from Story 4.1
  - [ ] Use confidence score to influence box assignment
  - [ ] Low confidence (<60%) → keep in lower boxes (more frequent review)
  - [ ] High confidence (>80%) → allow promotion to higher boxes
  - [ ] Medium confidence (60-80%) → normal progression

- [ ] Add date utilities using date-fns (AC: 2, 5)
  - [ ] Install/verify `date-fns` is in dependencies
  - [ ] Use `addDays()` to calculate next review dates
  - [ ] Use `isAfter()`, `isBefore()` for date comparisons
  - [ ] Use `differenceInDays()` for interval calculations

- [ ] Create comprehensive unit tests (AC: 8)
  - [ ] Create test file `/lib/algorithms/spaced-repetition.test.ts`
  - [ ] Test: New word starts in Box 1
  - [ ] Test: Correct answer promotes to next box
  - [ ] Test: Incorrect answer demotes to Box 1
  - [ ] Test: Box intervals are correct (1, 3, 7, 14 days)
  - [ ] Test: `getNextWords()` returns words due for review
  - [ ] Test: `getNextWords()` prioritizes Box 1 over Box 5
  - [ ] Test: Within-session logic includes struggling words multiple times
  - [ ] Test: High confidence words have longer intervals
  - [ ] Run tests with `npm run test`

- [ ] Persist review schedules to IndexedDB
  - [ ] Create storage functions in `/lib/storage/spaced-repetition-storage.ts`
  - [ ] Implement `saveReviewSchedule(schedule)`
  - [ ] Implement `loadReviewSchedules(wordListId)`
  - [ ] Update schedules after each game session
  - [ ] Handle storage errors gracefully

## Dev Notes

### Architecture Context

**File Structure:**
[Source: docs/ui-architecture.md#Project Structure]
```
lib/
├── algorithms/
│   ├── spaced-repetition.ts       # Leitner system implementation
│   ├── spaced-repetition.test.ts  # Unit tests
│   ├── confidence-scoring.ts      # From Story 4.1
│   └── word-selection.ts          # Future enhancement
```

**Spaced Repetition Overview:**
[Source: docs/prd.md#Epic 4 - Story 4.3]

The spaced repetition system optimizes when words should be reviewed for maximum retention:
- **Within-session**: Struggling words appear 2-3 times in same session
- **Cross-session**: Words scheduled for future sessions based on mastery
- **Adaptive intervals**: Time between reviews increases as confidence grows

**Leitner System (Recommended Approach):**

The Leitner system uses "boxes" with increasing review intervals:

```
Box 1 (Struggling):  Review same session / next day
Box 2 (Learning):    Review after 1 day
Box 3 (Progressing): Review after 3 days
Box 4 (Strong):      Review after 7 days
Box 5 (Mastered):    Review after 14+ days
```

**Movement Rules:**
- ✅ Correct answer → Promote to next box (unless already in Box 5)
- ❌ Incorrect answer → Demote back to Box 1
- Confidence score influences whether promotion is allowed

**Data Structure:**
```typescript
interface ReviewSchedule {
  wordId: string
  word: string
  currentBox: 1 | 2 | 3 | 4 | 5
  reviewCount: number
  lastReviewDate: Date
  nextReviewDate: Date
  confidenceScore: number  // From Story 4.1
  consecutiveCorrect: number
  consecutiveIncorrect: number
}
```

**Algorithm Functions:**
```typescript
// Core functions to implement
function promoteWord(schedule: ReviewSchedule): ReviewSchedule
function demoteWord(schedule: ReviewSchedule): ReviewSchedule
function getNextWords(schedules: ReviewSchedule[], maxWords: number): string[]
function getWordsForSession(wordList: string[], sessionLength: number): string[]
function calculateNextReviewDate(box: number, baseDate: Date): Date
```

**Integration with Confidence Scoring:**
[Source: Story 4.1, Story 4.2]
- Use confidence scores to validate box assignments
- Low confidence prevents promotion to higher boxes
- High confidence enables faster progression
- Sync review schedules with adaptive engine context

**Date Utilities:**
[Source: docs/ui-architecture.md#Tech Stack]
- Library: `date-fns` (already in dependencies)
- Use for date arithmetic and comparisons
- Tree-shakeable (only import what you need)

```typescript
import { addDays, isAfter, differenceInDays } from 'date-fns'

// Example: Calculate next review based on box
const intervals = [0, 1, 3, 7, 14] // days for boxes 1-5
const nextDate = addDays(new Date(), intervals[currentBox])
```

### Dependencies

**Required:**
- Story 4.1 (Confidence Scoring Algorithm) - MUST be complete
  - Provides `ConfidenceScore` type and confidence values
- Story 4.2 (Adaptive Engine Machine) - MUST be complete
  - Provides context for storing review schedules

**Future Integration:**
- Story 4.5 (Adaptive Game Selection) - Will use `getNextWords()` for word selection
- Story 4.7 (Integration) - Will integrate spaced repetition into game flow

### Testing

[Source: docs/ui-architecture.md#Testing Strategy]

**Testing Framework:** Vitest
**Test Location:** `/lib/algorithms/spaced-repetition.test.ts`
**Coverage Target:** 70%+ for algorithm functions

**Test Scenarios:**
```typescript
import { describe, it, expect } from 'vitest'
import { addDays } from 'date-fns'
import {
  promoteWord,
  demoteWord,
  getNextWords,
  calculateNextReviewDate
} from './spaced-repetition'

describe('Spaced Repetition - Leitner System', () => {
  it('new word starts in Box 1', () => {
    const schedule = initializeReviewSchedule('cat')
    expect(schedule.currentBox).toBe(1)
  })

  it('correct answer promotes to next box', () => {
    const initial = { currentBox: 1, confidenceScore: 70 }
    const promoted = promoteWord(initial)
    expect(promoted.currentBox).toBe(2)
  })

  it('incorrect answer demotes to Box 1', () => {
    const initial = { currentBox: 4, confidenceScore: 40 }
    const demoted = demoteWord(initial)
    expect(demoted.currentBox).toBe(1)
  })

  it('box intervals increase correctly', () => {
    const baseDate = new Date('2025-01-01')
    expect(calculateNextReviewDate(1, baseDate)).toEqual(addDays(baseDate, 0))
    expect(calculateNextReviewDate(2, baseDate)).toEqual(addDays(baseDate, 1))
    expect(calculateNextReviewDate(3, baseDate)).toEqual(addDays(baseDate, 3))
    expect(calculateNextReviewDate(4, baseDate)).toEqual(addDays(baseDate, 7))
    expect(calculateNextReviewDate(5, baseDate)).toEqual(addDays(baseDate, 14))
  })

  it('getNextWords prioritizes Box 1 words', () => {
    const schedules = [
      { wordId: 'word1', currentBox: 5, nextReviewDate: today },
      { wordId: 'word2', currentBox: 1, nextReviewDate: today },
      { wordId: 'word3', currentBox: 3, nextReviewDate: today }
    ]
    const next = getNextWords(schedules, 10)
    expect(next[0]).toBe('word2') // Box 1 comes first
  })
})
```

**Run Tests:**
```bash
npm run test                  # Run in watch mode
npm run test:coverage         # Generate coverage
```

### Technical Constraints

- Pure functions: No side effects, fully testable
- Immutable: Do not mutate input schedules
- TypeScript strict mode: All types explicitly defined
- Performance: Algorithm should handle 100+ words efficiently (<50ms)
- Date handling: Use date-fns for all date operations

### Previous Story Insights

From Story 4.1 (Confidence Scoring):
- Confidence thresholds: <60% needs work, 60-80% progressing, >80% mastered
- Use these thresholds to influence box promotion/demotion

From Story 4.2 (Adaptive Engine Machine):
- Review schedules will be stored in adaptive engine context
- Integration point: Machine will call `getNextWords()` for word selection

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
