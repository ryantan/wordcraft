# Story 7.1: OpenAI Integration Infrastructure

## Status

Ready for Review

## Parent Epic

[Epic 7: AI-Powered Story Generation]

## Dependencies

**Required (Must be complete first):**
- âœ… Epic 6: Story Mode (complete story generation system exists)

## Story

**As a** developer,
**I want** OpenAI API client infrastructure and basic prompt engineering setup,
**so that** the application can connect to OpenAI's API and generate story content dynamically.

## Acceptance Criteria

1. OpenAI API client properly configured and authenticated
2. Environment variables for API key management implemented  
3. Basic prompt templates for story generation created
4. Error handling for API connection failures implemented
5. TypeScript interfaces for OpenAI requests/responses defined
6. Unit tests for API client functionality created
7. API client follows existing project patterns and standards

## Tasks / Subtasks

- [x] Set up OpenAI API client (AC: 1, 5)
  - [x] Install and configure OpenAI SDK  
  - [x] Create `lib/openai/client.ts` with API client setup
  - [x] Define TypeScript interfaces for requests/responses
  - [x] Add proper error typing for API failures

- [x] Environment configuration (AC: 2)
  - [x] Add OPENAI_API_KEY to environment variables
  - [x] Create environment validation for required API key
  - [x] Add development/production environment handling
  - [x] Update .env.example with OpenAI configuration

- [x] Basic prompt engineering (AC: 3)
  - [x] Create `lib/openai/prompts.ts` with base prompt templates
  - [x] Design prompt structure for story generation
  - [x] Include theme, word list, and beat type parameters
  - [x] Add prompt validation and sanitization

- [x] Error handling infrastructure (AC: 4)
  - [x] Create custom error classes for OpenAI failures
  - [x] Implement retry logic with exponential backoff
  - [x] Add timeout handling for API requests
  - [x] Design graceful degradation patterns

- [x] Testing setup (AC: 6)
  - [x] Create unit tests for API client
  - [x] Mock OpenAI responses for testing
  - [x] Test error scenarios and fallbacks
  - [x] Verify environment configuration handling

## Dev Notes

**Relevant Source Tree:**
- `lib/story/story-generator.ts` - Current story generation logic to be enhanced
- `lib/story/content.ts` - Existing template system that will serve as fallback
- `types/story.ts` - Story beat interfaces that OpenAI must conform to
- `machines/story/storySessionMachine.ts` - Calls generateStory() function

**Integration Points:**
- Preserve existing `generateStory()` function signature in story-generator.ts
- OpenAI client should be imported and used within existing generation flow
- Error handling must allow fallback to existing template system
- Generated content must match existing beat type interfaces

**Key Technical Requirements:**
- Use Next.js API route patterns for server-side API calls if needed
- Follow existing error handling patterns from the codebase
- Maintain TypeScript strict mode compliance
- Use existing logging/monitoring patterns

### Testing

**Test Framework:** Vitest (existing project standard)
**Test Location:** `lib/openai/client.test.ts`, `lib/openai/prompts.test.ts`
**Mock Strategy:** Mock OpenAI API responses using MSW or vitest.mock
**Coverage Requirements:** Unit tests for all API client methods and error scenarios

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-21 | 1.0 | Initial story creation for OpenAI infrastructure | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

Claude Opus 4 (claude-opus-4-20250514)

### Debug Log References  

- Installed OpenAI SDK dependency (openai@6.6.0)
- Created OpenAI client with authentication and retry logic
- Implemented environment validation with clear error messages
- Added comprehensive error handling with custom error classes
- All unit tests passing for client and prompt modules

### Completion Notes List

- OpenAI SDK installed and configured with TypeScript support
- Environment validation ensures API key is present before client creation
- Retry logic with exponential backoff handles transient failures
- Timeout handling prevents hanging requests
- Story integration service created for seamless fallback to template system
- Comprehensive test coverage for all OpenAI functionality
- Prompt templates designed for narrative, game, and choice beats
- Sanitization functions protect against prompt injection

### File List

- Created: `/lib/openai/client.ts` - OpenAI client setup with error handling
- Created: `/lib/openai/prompts.ts` - Prompt templates and parsing functions
- Created: `/lib/openai/story-integration.ts` - Integration with story generator
- Created: `/lib/openai/client.test.ts` - Unit tests for OpenAI client
- Created: `/lib/openai/prompts.test.ts` - Unit tests for prompt templates
- Modified: `/lib/env.ts` - Added server environment configuration
- Modified: `/.env.local` - Added OPENAI_API_KEY placeholder
- Created: `/.env.example` - Example environment configuration
- Modified: `/package.json` - Added openai dependency

## QA Results

_To be populated by QA agent_