# Story 6.4a: Create StorySessionMachine

## Status

Draft

## Parent Story

[Story 6.4: Create Story Mode Flow](./6.4.integrate-story-checkpoints.md)

## Story

**As a** developer,
**I want** an XState machine to orchestrate story beat progression,
**so that** the story mode has predictable, testable state management for word selection and game flow.

## Acceptance Criteria

1. `StorySessionMachine` is created in `machines/story/storySessionMachine.ts`
2. Machine has all required states: idle, selectingWordList, initializingStory, showingIntro, preparingBeat, playingBeat, beatCompleted, showingCheckpoint, finale
3. Machine spawns `StoryProgressMachine` as child actor
4. Context includes: wordList, storyBeats, wordStats, currentPhase, currentWord, currentGameType
5. Word selection implements two-phase algorithm: assessment (random order) → mastery (prioritize difficult words)
6. Beat progression logic: cycles through 15-20 beats or until all words mastered
7. Checkpoint detection: transitions to showingCheckpoint when StoryProgressMachine reaches checkpoint states
8. Machine persists state to sessionStorage
9. Comprehensive unit tests (30+ tests covering all transitions, guards, actions)
10. All types exported from machine module

## Tasks / Subtasks

- [ ] Create machine file structure
  - [ ] Create directory `machines/story/`
  - [ ] Create file `storySessionMachine.ts`
  - [ ] Create file `storySessionMachine.test.ts`
  - [ ] Create file `index.ts` for exports
  - [ ] Add types to `types/story.ts`

- [ ] Define machine context types
  - [ ] `StorySessionContext` interface
  - [ ] `StoryBeat` interface
  - [ ] `WordStats` interface (confidence, errors, hints, time, streak)
  - [ ] `StorySessionEvent` type union
  - [ ] Export all types

- [ ] Define machine states
  - [ ] `idle` - Initial state
  - [ ] `selectingWordList` - User picks word list
  - [ ] `initializingStory` - Generate beats, spawn actors
  - [ ] `showingIntro` - Display story introduction
  - [ ] `preparingBeat` - Select word + game mechanic
  - [ ] `playingBeat` - User plays game
  - [ ] `beatCompleted` - Process results, check for checkpoint
  - [ ] `showingCheckpoint` - Display checkpoint screen
  - [ ] `finale` - Story complete

- [ ] Define machine events
  - [ ] `WORD_LIST_SELECTED` - User chose word list
  - [ ] `START_STORY` - User clicked start from intro
  - [ ] `BEAT_COMPLETED` - Game finished (includes result data)
  - [ ] `CONTINUE_STORY` - Continue from checkpoint
  - [ ] `SKIP_CHECKPOINT` - Skip checkpoint screen
  - [ ] `RESTART_STORY` - Start over

- [ ] Implement word selection algorithms
  - [ ] Create `lib/story/word-selection.ts`
  - [ ] `selectWordForAssessment()` - Random from unassessed words
  - [ ] `selectWordForMastery()` - Prioritize by difficulty score
  - [ ] `calculateDifficultyScore()` - Multi-factor difficulty calculation
  - [ ] `weightedRandomSelect()` - Weighted selection for variety
  - [ ] `initializeWordStats()` - Create initial stats for word
  - [ ] `updateWordStats()` - Update after game completion

- [ ] Implement game mechanic selection
  - [ ] Create `lib/story/game-selection.ts`
  - [ ] `selectGameMechanic(word, context)` - Choose appropriate game
  - [ ] Cycle through game types for variety
  - [ ] Consider word characteristics (length, difficulty)

- [ ] Implement machine actions
  - [ ] `setWordList` - Store selected word list
  - [ ] `spawnStoryProgressActor` - Create child actor
  - [ ] `generateStoryBeats` - Create 15-20 beat structure
  - [ ] `initializeWordStats` - Create stats map for all words
  - [ ] `loadIntroContent` - Get intro from story content
  - [ ] `selectWordAndGame` - Run word selection algorithm
  - [ ] `updateWordStats` - Process game results
  - [ ] `incrementBeatsCompleted` - Track progress
  - [ ] `notifyStoryProgress` - Send GAME_COMPLETED to child
  - [ ] `loadCheckpointData` - Get checkpoint content
  - [ ] `resetContinueDelay` - Reset continue button state
  - [ ] `enableContinueButton` - Allow user to continue
  - [ ] `acknowledgeCheckpoint` - Send CONTINUE_STORY to child
  - [ ] `skipCheckpoint` - Skip without notifying child
  - [ ] `loadFinaleContent` - Get finale content

- [ ] Implement machine guards
  - [ ] `shouldShowCheckpoint` - Check if child is at checkpoint
  - [ ] `shouldShowFinale` - Check if all words mastered OR beats exhausted
  - [ ] `hasMoreBeats` - Check if beats remaining
  - [ ] `allWordsAssessed` - Check if assessment phase complete

- [ ] Implement state persistence
  - [ ] Save context to sessionStorage on state transitions
  - [ ] Load persisted state on machine initialization
  - [ ] Handle serialization of Maps and Sets
  - [ ] Handle Date serialization

- [ ] Create comprehensive tests
  - [ ] Test: Machine initializes correctly
  - [ ] Test: Word list selection flow
  - [ ] Test: Story initialization (spawn actor, generate beats)
  - [ ] Test: Intro → first beat transition
  - [ ] Test: Beat preparation (word + game selection)
  - [ ] Test: Beat completion updates stats
  - [ ] Test: Assessment phase (all words practiced once)
  - [ ] Test: Mastery phase (prioritizes difficult words)
  - [ ] Test: Checkpoint detection (5, 10, 15 games)
  - [ ] Test: Checkpoint → next beat transition
  - [ ] Test: Finale when all words mastered
  - [ ] Test: Finale when beats exhausted
  - [ ] Test: State persistence and restoration
  - [ ] Test: All guards return correct values
  - [ ] Test: All actions update context correctly
  - [ ] Run tests with `pnpm test`

## Dev Notes

### Machine Architecture

```typescript
// machines/story/storySessionMachine.ts
import { createMachine, assign, spawn } from 'xstate'
import { storyProgressMachine } from '@/lib/story/machines/storyProgressMachine'
import type { StorySessionContext, StorySessionEvent } from '@/types/story'

export const storySessionMachine = createMachine({
  id: 'storySession',
  initial: 'idle',
  context: ({ input }) => ({
    // Word list
    wordList: null,
    wordPool: [],

    // Selection phase
    currentPhase: 'assessment',
    assessedWords: new Set<string>(),
    wordStats: new Map<string, WordStats>(),

    // Story beats
    storyBeats: [],
    totalBeats: 20,
    currentBeatIndex: 0,
    beatsCompleted: 0,

    // Current beat
    currentWord: null,
    currentGameType: null,

    // Story integration
    storyProgressActor: null,
    storyTheme: 'space',

    // Checkpoint data
    currentCheckpoint: null,
    canContinueStory: false,

    // Content
    introContent: null,
    finaleContent: null,

    // Session
    sessionStartTime: new Date(),
  }),

  states: {
    idle: {
      on: {
        WORD_LIST_SELECTED: {
          target: 'initializingStory',
          actions: 'setWordList'
        }
      }
    },

    initializingStory: {
      entry: [
        'spawnStoryProgressActor',
        'generateStoryBeats',
        'initializeWordStats',
        'loadIntroContent'
      ],
      always: 'showingIntro'
    },

    // ... other states
  }
})
```

### Word Selection Algorithm

See [parent story architectural diagrams](./6.4.integrate-story-checkpoints.md) for full algorithm details.

**Phase 1: Assessment**
- Random selection from unassessed words
- Each word practiced at least once
- Collects baseline data: confidence, errors, hints, time

**Phase 2: Mastery**
- Calculate difficulty score for each word
- Factors: confidence, hints used, wrong letters, time, accuracy, recency, streak
- Weighted random selection (bias toward difficult words, but maintain variety)

### Dependencies

**Required:**
- Story 6.2 (StoryProgressMachine) - Must be complete
- Story 6.3 (Narrative Content) - Provides intro/checkpoint/finale text
- XState 5.x - State machine library
- Existing confidence scoring algorithms

**Installation:**
No new dependencies - uses existing XState

### Testing Strategy

**Test Coverage Goals:**
- 100% state coverage (all states reachable)
- 100% transition coverage (all guards tested)
- 100% action coverage (all actions tested)
- Edge cases: empty word lists, all words mastered early, etc.

**Test Structure:**
```typescript
describe('StorySessionMachine', () => {
  describe('Initialization', () => {
    it('starts in idle state', () => {})
    it('loads persisted state if available', () => {})
  })

  describe('Word List Selection', () => {
    it('transitions to initializingStory on selection', () => {})
    it('stores word list in context', () => {})
  })

  describe('Story Initialization', () => {
    it('spawns StoryProgressMachine', () => {})
    it('generates 20 story beats', () => {})
    it('initializes word stats for all words', () => {})
    it('loads intro content for theme', () => {})
  })

  describe('Beat Progression', () => {
    it('selects random word in assessment phase', () => {})
    it('prioritizes difficult words in mastery phase', () => {})
    it('selects appropriate game mechanic', () => {})
    it('updates word stats on completion', () => {})
    it('increments beat counter', () => {})
  })

  describe('Checkpoint Detection', () => {
    it('shows checkpoint after 5 games', () => {})
    it('shows checkpoint after 10 games', () => {})
    it('shows checkpoint after 15 games', () => {})
    it('does not show checkpoint for other beat counts', () => {})
  })

  describe('Finale Conditions', () => {
    it('shows finale when all words mastered', () => {})
    it('shows finale when all beats complete', () => {})
  })

  describe('Persistence', () => {
    it('persists state to sessionStorage', () => {})
    it('restores state on page refresh', () => {})
    it('handles serialization of Maps and Sets', () => {})
  })
})
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial substory created from parent Story 6.4 | James (Dev) |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
