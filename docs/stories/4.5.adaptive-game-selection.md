# Story 4.5: Implement Adaptive Game Selection

## Status

Draft

## Story

**As a** child,
**I want** the system to select games that work well for how I learn,
**so that** practice is more effective and engaging for me.

## Acceptance Criteria

1. `GameSessionMachine` integrates with `AdaptiveEngineMachine` for game selection
2. Game selection algorithm considers: learning style profile, game variety, word difficulty
3. System favors game types aligned with child's detected learning style (60-70% of selections)
4. System ensures variety by not repeating same game type consecutively
5. Easier words paired with more challenging games; harder words with simpler games
6. Selection logic is configurable and can be tuned based on testing
7. System logs game selection rationale for debugging/analysis
8. Unit tests verify game selection distribution matches learning style profile

## Tasks / Subtasks

- [ ] Create game selection algorithm (AC: 1, 2)
  - [ ] Create file `/lib/algorithms/game-selection.ts`
  - [ ] Import learning style profile from Story 4.4
  - [ ] Import confidence scores from Story 4.1
  - [ ] Define `selectGame(word, profile, history)` function signature

- [ ] Implement style-based selection (AC: 2, 3)
  - [ ] Get available games for current word difficulty
  - [ ] Filter games by learning style alignment
  - [ ] Weight game selection by style profile scores
  - [ ] 60-70% chance to select aligned game
  - [ ] 30-40% chance to select other games (for variety and style detection)

- [ ] Ensure game variety (AC: 4)
  - [ ] Track last N games played (history parameter)
  - [ ] Prevent same game type from repeating consecutively
  - [ ] If last 2 games were same type, exclude that type
  - [ ] Maintain variety across session (no game appears >3 times in 10 rounds)

- [ ] Implement difficulty balancing (AC: 5)
  - [ ] Get word confidence score
  - [ ] Define game difficulty ratings: easy (1), medium (2), hard (3)
  - [ ] Game difficulty mapping:
    - Easy: Word Scramble, Letter Matching
    - Medium: Missing Letters, Picture Reveal, Word Building
    - Hard: Spelling Challenge, Letter Hunt, Trace & Write
  - [ ] Match word difficulty to game difficulty:
    - Low confidence word (<60%) → Easy/Medium games
    - Medium confidence (60-80%) → All games
    - High confidence (>80%) → Medium/Hard games

- [ ] Make selection logic configurable (AC: 6)
  - [ ] Create configuration object:
    ```typescript
    const GAME_SELECTION_CONFIG = {
      styleAlignmentWeight: 0.65,      // 65% aligned to style
      varietyWeight: 0.20,              // 20% for variety
      difficultyBalanceWeight: 0.15,    // 15% for difficulty match
      minGapBetweenRepeats: 2           // Don't repeat game within 2 turns
    }
    ```
  - [ ] Allow weights to be adjusted for tuning
  - [ ] Export config for testing different strategies

- [ ] Add selection logging (AC: 7)
  - [ ] Log selection rationale: `{ word, selectedGame, styleScore, varietyScore, difficultyScore, reason }`
  - [ ] Use console.debug in development mode
  - [ ] Store selection history for analysis
  - [ ] Create helper function `explainSelection(decision)` for debugging

- [ ] Integrate with AdaptiveEngineMachine (AC: 1)
  - [ ] Update `selectGame` service in `adaptiveEngineMachine.ts`
  - [ ] Call `selectGame()` algorithm from machine
  - [ ] Pass learning style profile from machine context
  - [ ] Pass confidence scores from machine context
  - [ ] Return selected game type to session machine

- [ ] Create comprehensive unit tests (AC: 8)
  - [ ] Create test file `/lib/algorithms/game-selection.test.ts`
  - [ ] Test: Visual profile results in 60-70% visual games over 100 selections
  - [ ] Test: Same game doesn't repeat consecutively
  - [ ] Test: Low confidence word gets easier game
  - [ ] Test: High confidence word gets harder game
  - [ ] Test: Game distribution respects variety constraints
  - [ ] Test: Balanced profile results in balanced game selection
  - [ ] Test: Configuration adjustments change selection behavior
  - [ ] Run tests with `npm run test`

## Dev Notes

### Architecture Context

**File Structure:**
```
lib/
├── algorithms/
│   ├── game-selection.ts       # Game selection algorithm
│   ├── game-selection.test.ts  # Unit tests
```

**Game Type to Learning Style Mapping:**
[Source: Story 4.4]
```typescript
const GAME_STYLES: Record<GameType, LearningStyle[]> = {
  'word-scramble': ['visual'],
  'missing-letters': ['visual'],
  'letter-matching': ['visual', 'kinesthetic'],
  'spelling-challenge': ['auditory'],
  'letter-hunt': ['kinesthetic', 'visual'],
  'trace-write': ['kinesthetic'],
  'picture-reveal': ['visual'],
  'word-building': ['kinesthetic', 'visual']
}
```

**Game Difficulty Ratings:**
```typescript
const GAME_DIFFICULTY: Record<GameType, 1 | 2 | 3> = {
  'word-scramble': 1,      // Easy
  'letter-matching': 1,     // Easy
  'missing-letters': 2,     // Medium
  'picture-reveal': 2,      // Medium
  'word-building': 2,       // Medium
  'spelling-challenge': 3,  // Hard
  'letter-hunt': 3,         // Hard
  'trace-write': 3          // Hard
}
```

**Selection Algorithm Pseudocode:**
```typescript
function selectGame(
  word: Word,
  profile: LearningStyleProfile,
  confidenceScore: number,
  gameHistory: GameType[]
): GameType {
  // 1. Get appropriate games for word difficulty
  const wordDifficulty = confidenceScore < 0.6 ? 'easy' :
                        confidenceScore < 0.8 ? 'medium' : 'hard'
  const suitableGames = filterGamesByDifficulty(wordDifficulty)

  // 2. Exclude recently played games
  const availableGames = suitableGames.filter(game =>
    !gameHistory.slice(-2).includes(game)
  )

  // 3. Calculate weighted scores for each game
  const scoredGames = availableGames.map(game => ({
    game,
    styleScore: calculateStyleAlignment(game, profile),
    varietyScore: calculateVarietyScore(game, gameHistory),
    difficultyScore: calculateDifficultyMatch(game, confidenceScore)
  }))

  // 4. Weighted random selection
  const selectedGame = weightedRandomChoice(scoredGames, GAME_SELECTION_CONFIG)

  // 5. Log decision
  logSelectionReason(word, selectedGame, scoredGames)

  return selectedGame
}
```

**Integration with Adaptive Engine:**
[Source: Story 4.2]
- Update the `selectGame` service in `adaptiveEngineMachine.ts`
- Service will call this algorithm and return game type
- GameSessionMachine queries adaptive engine for game selection

### Dependencies

**Required:**
- Story 4.1 (Confidence Scoring) - Provides confidence scores
- Story 4.2 (Adaptive Engine Machine) - Integration point
- Story 4.4 (Learning Style Detection) - Provides learning style profile

**Builds Upon:**
- Epic 3 (Core Game Mechanics Part 1) - 4 games available
- Will be enhanced in Epic 5 when 4 more games are added

### Testing

[Source: docs/ui-architecture.md#Testing Strategy]

**Testing Framework:** Vitest
**Test Location:** `/lib/algorithms/game-selection.test.ts`
**Coverage Target:** 70%+

**Test Scenarios:**
```typescript
import { describe, it, expect } from 'vitest'
import { selectGame } from './game-selection'

describe('Adaptive Game Selection', () => {
  it('favors visual games for visual learner', () => {
    const profile = { visual: 0.7, auditory: 0.1, kinesthetic: 0.2 }
    const selections = []

    for (let i = 0; i < 100; i++) {
      const game = selectGame('cat', profile, 0.5, [])
      selections.push(game)
    }

    const visualGames = selections.filter(g =>
      ['word-scramble', 'missing-letters', 'picture-reveal'].includes(g)
    )

    expect(visualGames.length).toBeGreaterThan(60)
    expect(visualGames.length).toBeLessThan(75)
  })

  it('prevents consecutive same game', () => {
    const profile = { visual: 0.33, auditory: 0.33, kinesthetic: 0.34 }
    const history = ['word-scramble', 'word-scramble']

    for (let i = 0; i < 10; i++) {
      const game = selectGame('cat', profile, 0.5, history)
      expect(game).not.toBe('word-scramble')
    }
  })

  it('selects easier games for low confidence words', () => {
    const lowConfidenceSelections = []

    for (let i = 0; i < 50; i++) {
      const game = selectGame('difficult', defaultProfile, 0.3, [])
      lowConfidenceSelections.push(game)
    }

    const easyGames = lowConfidenceSelections.filter(g =>
      ['word-scramble', 'letter-matching'].includes(g)
    )

    expect(easyGames.length).toBeGreaterThan(25) // >50% easy games
  })
})
```

**Run Tests:**
```bash
npm run test
npm run test:coverage
```

### Technical Constraints

- Pure function: No side effects
- TypeScript strict mode
- Performance: Selection should execute in <10ms
- Randomness: Use weighted random selection, not purely deterministic
- Configurability: All weights exposed for tuning

### Previous Story Insights

From Story 4.4 (Learning Style Detection):
- Learning style profile structure and game-style mappings
- Use profile scores to weight game selection

From Story 4.2 (Adaptive Engine Machine):
- Game selection happens in `selectGame` service
- Machine provides context (profile, confidence, history)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
