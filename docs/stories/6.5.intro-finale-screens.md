# Story 6.5: Create Story Introduction and Finale Screens

## Status

Draft

## Story

**As a** child,
**I want** to see a story introduction when I start and a finale when I finish,
**so that** the experience has a clear beginning and satisfying ending.

## Acceptance Criteria

1. Story intro screen displays when starting a new word list for the first time
2. Intro includes: character introduction, narrative setup, "Let's Begin" button
3. Story finale screen displays when all words in list reach mastery (>80% confidence)
4. Finale includes: celebration animation, congratulatory message, character completion visual
5. Finale shows summary: words mastered, games played, time spent
6. Finale offers options: "Practice More", "Try New Words", "View Progress"
7. Intro and finale are visually distinct and celebratory
8. Screens are responsive and work on mobile and desktop

## Tasks / Subtasks

- [ ] Create StoryIntroScreen component (AC: 1, 2, 7, 8)
  - [ ] Create file `/components/story/StoryIntroScreen.tsx`
  - [ ] Component props:
    ```typescript
    interface StoryIntroScreenProps {
      theme: string
      wordListName: string
      wordCount: number
      onBegin: () => void
    }
    ```
  - [ ] Full-screen layout with background
  - [ ] Character introduction visual
  - [ ] Narrative text from story content
  - [ ] "Let's Begin!" call-to-action button
  - [ ] Responsive design for mobile/desktop

- [ ] Design intro screen layout (AC: 2, 7)
  - [ ] Background: First environment from theme (e.g., space station)
  - [ ] Character: Large, centered character sprite (neutral pose)
  - [ ] Title: "Begin Your Adventure" or theme-specific title
  - [ ] Narrative: Intro narrative from story content
  - [ ] Word list info: "Ready to master {wordCount} words?"
  - [ ] CTA button: Large, prominent "Let's Begin!" button
  - [ ] Visual style: Exciting, welcoming, child-friendly

- [ ] Implement intro animations (AC: 7)
  - [ ] Background fade in (500ms)
  - [ ] Character slides in or zooms in (Framer Motion)
  - [ ] Text appears with stagger effect
  - [ ] Button pulses or glows to attract attention
  - [ ] Optional: Sparkles or stars animation
  - [ ] Smooth transitions throughout

- [ ] Create StoryFinaleScreen component (AC: 3, 4, 7, 8)
  - [ ] Create file `/components/story/StoryFinaleScreen.tsx`
  - [ ] Component props:
    ```typescript
    interface StoryFinaleScreenProps {
      theme: string
      wordListName: string
      stats: {
        wordsMastered: number
        gamesPlayed: number
        timeSpent: number
        totalWords: number
      }
      onPracticeMore: () => void
      onTryNewWords: () => void
      onViewProgress: () => void
    }
    ```
  - [ ] Full-screen layout with finale background
  - [ ] Celebration visuals and animations
  - [ ] Summary statistics display
  - [ ] Action buttons for next steps
  - [ ] Responsive design

- [ ] Design finale screen layout (AC: 4, 5, 6, 7)
  - [ ] Background: Final environment from theme (e.g., stars field)
  - [ ] Character: Celebrating pose (arms raised, happy)
  - [ ] Title: "Mission Complete!" or theme-specific
  - [ ] Narrative: Finale narrative from story content
  - [ ] Stats panel:
    - "‚úÖ {X} Words Mastered"
    - "üéÆ {Y} Games Played"
    - "‚è±Ô∏è {Z} Minutes of Practice"
  - [ ] Action buttons: Three clear options
  - [ ] Trophy or badge visual

- [ ] Implement finale animations (AC: 4, 7)
  - [ ] Confetti celebration (react-confetti)
  - [ ] Fireworks or stars bursting effect
  - [ ] Character celebration animation
  - [ ] Trophy/badge reveal with zoom effect
  - [ ] Stats count up animation (number incrementing)
  - [ ] Button entrance with stagger
  - [ ] Overall: Highly celebratory and rewarding feel

- [ ] Add intro trigger logic (AC: 1)
  - [ ] Detect when starting a new word list
  - [ ] Check if story intro has been seen for this list
  - [ ] Store flag in IndexedDB: `storyIntroSeen: { [listId]: boolean }`
  - [ ] GameSessionMachine state:
    ```typescript
    states: {
      initializing: {
        always: [
          {
            guard: 'shouldShowStoryIntro',
            target: 'showingIntro'
          },
          { target: 'selectingGame' }
        ]
      },
      showingIntro: {
        on: {
          BEGIN_STORY: {
            target: 'selectingGame',
            actions: 'markIntroAsSeen'
          }
        }
      }
    }
    ```

- [ ] Add finale trigger logic (AC: 3)
  - [ ] Monitor word confidence scores via AdaptiveEngineMachine
  - [ ] Detect when all words >= 80% confidence
  - [ ] Transition GameSessionMachine to `showingFinale` state
  - [ ] Calculate stats from session context:
    ```typescript
    guards: {
      shouldShowFinale: ({ context }) => {
        const allWordsMastered = context.words.every(
          word => context.adaptiveEngine.getConfidence(word) >= 0.8
        )
        return allWordsMastered
      }
    }
    ```

- [ ] Create stats calculation helper (AC: 5)
  - [ ] Create `/lib/stats/calculate-session-stats.ts`:
    ```typescript
    export function calculateSessionStats(sessionData) {
      return {
        wordsMastered: sessionData.words.filter(w => w.confidence >= 0.8).length,
        gamesPlayed: sessionData.gameResults.length,
        timeSpent: calculateTotalTime(sessionData.startTime, Date.now()),
        totalWords: sessionData.words.length,
        averageConfidence: calculateAverage(sessionData.words.map(w => w.confidence))
      }
    }
    ```
  - [ ] Format time in minutes or hours
  - [ ] Round percentages appropriately

- [ ] Implement intro content integration (AC: 2)
  - [ ] Load intro from `/lib/story/content.ts`
  - [ ] Interpolate word count into narrative
  - [ ] Display theme-specific content
  - [ ] Load appropriate character and background images

- [ ] Implement finale content integration (AC: 4)
  - [ ] Load finale from `/lib/story/content.ts`
  - [ ] Interpolate stats into narrative if template variables used
  - [ ] Display completion character sprite
  - [ ] Load finale background image

- [ ] Create action button handlers (AC: 6)
  - [ ] "Practice More" ‚Üí Reset session, continue with same word list
  - [ ] "Try New Words" ‚Üí Navigate to word list selection/creation
  - [ ] "View Progress" ‚Üí Navigate to dashboard
  - [ ] Buttons clearly labeled and visually distinct
  - [ ] Track button selections for analytics

- [ ] Add responsive design (AC: 8)
  - [ ] Mobile (375px):
    - Vertical layout
    - Smaller character sprites
    - Stacked buttons
    - Readable text sizes
  - [ ] Tablet (768px):
    - Balanced layout
    - Medium character sprites
    - Two-column button layout
  - [ ] Desktop (1920px):
    - Cinematic layout
    - Large character sprites
    - Horizontal button row
  - [ ] Test all breakpoints

- [ ] Create skip/replay options
  - [ ] Intro: Small "Skip Intro" button (don't encourage, but allow)
  - [ ] Finale: Can replay finale animation
  - [ ] Remember preference for future sessions (optional)

- [ ] Handle edge cases
  - [ ] User closes browser during intro/finale: Don't re-show
  - [ ] Multiple word lists: Track intro seen per list
  - [ ] Partial mastery: Don't show finale until ALL words mastered
  - [ ] Session timeout: Finale available on return if mastery achieved

- [ ] Create React hooks
  - [ ] Create `/hooks/useStoryIntro.ts`:
    ```typescript
    export function useStoryIntro(wordListId: string) {
      const [hasSeenIntro, setHasSeenIntro] = useState(false)

      useEffect(() => {
        // Load from IndexedDB
        const seen = await loadIntroSeenStatus(wordListId)
        setHasSeenIntro(seen)
      }, [wordListId])

      const markIntroAsSeen = async () => {
        await saveIntroSeenStatus(wordListId, true)
        setHasSeenIntro(true)
      }

      return { hasSeenIntro, markIntroAsSeen }
    }
    ```
  - [ ] Create `/hooks/useStoryFinale.ts`:
    ```typescript
    export function useStoryFinale() {
      const stats = useSessionStats()
      const shouldShowFinale = stats.allWordsMastered

      return { shouldShowFinale, stats }
    }
    ```

- [ ] Create component tests
  - [ ] Create test file `/components/story/StoryIntroScreen.test.tsx`
  - [ ] Test: Renders intro content
  - [ ] Test: Begin button calls onBegin
  - [ ] Test: Displays word count
  - [ ] Test: Responsive layout works
  - [ ] Create test file `/components/story/StoryFinaleScreen.test.tsx`
  - [ ] Test: Renders finale content
  - [ ] Test: Displays stats correctly
  - [ ] Test: All action buttons work
  - [ ] Test: Animations render without errors
  - [ ] Run tests with `npm run test`

- [ ] Create integration tests
  - [ ] Test: Intro shows when starting new word list
  - [ ] Test: Intro doesn't show on subsequent sessions
  - [ ] Test: Finale shows when all words mastered
  - [ ] Test: Stats calculated correctly
  - [ ] Test: Action buttons navigate correctly
  - [ ] Run tests with `npm run test`

## Dev Notes

### Architecture Context

**StoryIntroScreen Component:**
```typescript
'use client'

import { motion } from 'framer-motion'
import { getStoryContent, interpolateContent } from '@/lib/story/content'
import { STORY_ASSETS } from '@/lib/story/assets'

interface StoryIntroScreenProps {
  theme: string
  wordListName: string
  wordCount: number
  onBegin: () => void
}

export function StoryIntroScreen({
  theme = 'space',
  wordListName,
  wordCount,
  onBegin
}: StoryIntroScreenProps) {
  const content = getStoryContent(theme)
  const assets = STORY_ASSETS[theme]

  return (
    <motion.div
      className="fixed inset-0 z-50 flex items-center justify-center overflow-hidden"
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      transition={{ duration: 0.8 }}
    >
      {/* Background */}
      <div
        className="absolute inset-0 bg-cover bg-center"
        style={{ backgroundImage: `url(${assets.backgrounds.intro})` }}
      />

      {/* Gradient Overlay */}
      <div className="absolute inset-0 bg-gradient-to-b from-purple-900/50 to-blue-900/50" />

      {/* Character */}
      <motion.img
        src={assets.characters.neutral}
        alt="Story character"
        className="absolute bottom-0 left-1/2 -translate-x-1/2 w-64 h-64 md:w-96 md:h-96"
        initial={{ y: 100, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        transition={{ type: 'spring', delay: 0.5 }}
      />

      {/* Content Box */}
      <motion.div
        className="relative z-10 max-w-3xl mx-auto p-8 md:p-12 text-center"
        initial={{ y: -50, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        transition={{ delay: 0.8 }}
      >
        <h1 className="text-5xl md:text-7xl font-bold text-white mb-6 drop-shadow-lg">
          {content.intro.title}
        </h1>

        <div className="text-6xl mb-6">{content.intro.celebrationEmoji}</div>

        <p className="text-2xl md:text-3xl text-white mb-4 leading-relaxed drop-shadow-md">
          {content.intro.narrative}
        </p>

        <p className="text-xl text-yellow-300 mb-8 font-semibold">
          Ready to master {wordCount} words from "{wordListName}"?
        </p>

        <motion.button
          onClick={onBegin}
          className="px-12 py-4 bg-gradient-to-r from-yellow-400 to-orange-500 text-white text-2xl font-bold rounded-full shadow-2xl hover:scale-105 transition-transform"
          whileHover={{ scale: 1.1 }}
          whileTap={{ scale: 0.95 }}
          animate={{ scale: [1, 1.05, 1] }}
          transition={{ repeat: Infinity, duration: 2 }}
        >
          Let's Begin! üöÄ
        </motion.button>
      </motion.div>
    </motion.div>
  )
}
```

**StoryFinaleScreen Component:**
```typescript
'use client'

import { motion } from 'framer-motion'
import { useState, useEffect } from 'react'
import Confetti from 'react-confetti'
import { getStoryContent } from '@/lib/story/content'
import { STORY_ASSETS } from '@/lib/story/assets'

interface StoryFinaleScreenProps {
  theme: string
  wordListName: string
  stats: {
    wordsMastered: number
    gamesPlayed: number
    timeSpent: number
    totalWords: number
  }
  onPracticeMore: () => void
  onTryNewWords: () => void
  onViewProgress: () => void
}

export function StoryFinaleScreen({
  theme = 'space',
  wordListName,
  stats,
  onPracticeMore,
  onTryNewWords,
  onViewProgress
}: StoryFinaleScreenProps) {
  const [countUpComplete, setCountUpComplete] = useState(false)
  const content = getStoryContent(theme)
  const assets = STORY_ASSETS[theme]

  useEffect(() => {
    const timer = setTimeout(() => setCountUpComplete(true), 3000)
    return () => clearTimeout(timer)
  }, [])

  return (
    <motion.div
      className="fixed inset-0 z-50 flex items-center justify-center overflow-hidden"
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
    >
      {/* Background */}
      <div
        className="absolute inset-0 bg-cover bg-center"
        style={{ backgroundImage: `url(${assets.backgrounds.finale})` }}
      />

      {/* Confetti */}
      <Confetti recycle={false} numberOfPieces={500} />

      {/* Character Celebrating */}
      <motion.img
        src={assets.characters.celebrating}
        alt="Character celebrating"
        className="absolute bottom-0 right-10 w-64 h-64 md:w-96 md:h-96"
        initial={{ scale: 0, rotate: -180 }}
        animate={{ scale: 1, rotate: 0 }}
        transition={{ type: 'spring', delay: 0.5 }}
      />

      {/* Trophy */}
      <motion.div
        className="absolute top-20 left-1/2 -translate-x-1/2 text-9xl"
        initial={{ scale: 0, y: -100 }}
        animate={{ scale: 1, y: 0 }}
        transition={{ type: 'spring', delay: 1 }}
      >
        üèÜ
      </motion.div>

      {/* Content */}
      <div className="relative z-10 max-w-4xl mx-auto p-8">
        <motion.div
          className="bg-white/95 rounded-3xl shadow-2xl p-8 md:p-12"
          initial={{ scale: 0.8, opacity: 0 }}
          animate={{ scale: 1, opacity: 1 }}
          transition={{ delay: 0.3 }}
        >
          <div className="text-center mb-8">
            <h1 className="text-5xl md:text-6xl font-bold text-purple-700 mb-4">
              {content.finale.title}
            </h1>
            <p className="text-2xl text-gray-700 leading-relaxed">
              {content.finale.narrative}
            </p>
          </div>

          {/* Stats */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <StatCard
              icon="‚úÖ"
              value={stats.wordsMastered}
              label="Words Mastered"
              delay={0.5}
            />
            <StatCard
              icon="üéÆ"
              value={stats.gamesPlayed}
              label="Games Played"
              delay={0.7}
            />
            <StatCard
              icon="‚è±Ô∏è"
              value={Math.round(stats.timeSpent / 60)}
              label="Minutes Practiced"
              delay={0.9}
            />
          </div>

          {/* Action Buttons */}
          <div className="flex flex-col md:flex-row gap-4 justify-center">
            <motion.button
              onClick={onPracticeMore}
              className="px-8 py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition-colors"
              whileHover={{ scale: 1.05 }}
              whileTap={{ scale: 0.95 }}
            >
              Practice More üìù
            </motion.button>
            <motion.button
              onClick={onTryNewWords}
              className="px-8 py-3 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition-colors"
              whileHover={{ scale: 1.05 }}
              whileTap={{ scale: 0.95 }}
            >
              Try New Words ‚ú®
            </motion.button>
            <motion.button
              onClick={onViewProgress}
              className="px-8 py-3 bg-purple-500 text-white rounded-lg font-semibold hover:bg-purple-600 transition-colors"
              whileHover={{ scale: 1.05 }}
              whileTap={{ scale: 0.95 }}
            >
              View Progress üìä
            </motion.button>
          </div>
        </motion.div>
      </div>
    </motion.div>
  )
}

function StatCard({ icon, value, label, delay }: any) {
  const [displayValue, setDisplayValue] = useState(0)

  useEffect(() => {
    const duration = 2000
    const steps = 60
    const increment = value / steps
    let current = 0

    const timer = setInterval(() => {
      current += increment
      if (current >= value) {
        setDisplayValue(value)
        clearInterval(timer)
      } else {
        setDisplayValue(Math.floor(current))
      }
    }, duration / steps)

    return () => clearInterval(timer)
  }, [value])

  return (
    <motion.div
      className="bg-gradient-to-br from-purple-100 to-blue-100 rounded-xl p-6 text-center"
      initial={{ scale: 0, opacity: 0 }}
      animate={{ scale: 1, opacity: 1 }}
      transition={{ delay }}
    >
      <div className="text-5xl mb-2">{icon}</div>
      <div className="text-4xl font-bold text-purple-700 mb-1">
        {displayValue}
      </div>
      <div className="text-sm text-gray-600 font-semibold">{label}</div>
    </motion.div>
  )
}
```

**GameSessionMachine Integration:**
```typescript
export const gameSessionMachine = createMachine({
  states: {
    initializing: {
      always: [
        {
          guard: 'shouldShowStoryIntro',
          target: 'showingIntro'
        },
        { target: 'selectingGame' }
      ]
    },
    showingIntro: {
      on: {
        BEGIN_STORY: {
          target: 'selectingGame',
          actions: 'markIntroAsSeen'
        }
      }
    },
    // ... game states
    completed: {
      always: [
        {
          guard: 'shouldShowFinale',
          target: 'showingFinale'
        },
        {
          guard: 'shouldShowCheckpoint',
          target: 'showingCheckpoint'
        },
        { target: 'selectingGame' }
      ]
    },
    showingFinale: {
      on: {
        PRACTICE_MORE: 'selectingGame',
        TRY_NEW_WORDS: { actions: 'navigateToWordLists' },
        VIEW_PROGRESS: { actions: 'navigateToDashboard' }
      }
    }
  }
}, {
  guards: {
    shouldShowStoryIntro: ({ context }) => {
      return !context.hasSeenIntro && context.storyModeEnabled
    },
    shouldShowFinale: ({ context }) => {
      return context.words.every(w => context.confidenceScores[w] >= 0.8)
    }
  },
  actions: {
    markIntroAsSeen: assign({ hasSeenIntro: true }),
    navigateToWordLists: () => {
      window.location.href = '/word-lists'
    },
    navigateToDashboard: () => {
      window.location.href = '/dashboard'
    }
  }
})
```

### Dependencies

**Required:**
- Story 6.1 (Story Theme Assets) - Background and character images
- Story 6.3 (Narrative Content) - Intro and finale text
- `react-confetti` - Finale celebration
- `framer-motion` - Animations

**Enables:**
- Story 6.7 (Testing) - Will test intro/finale flow

### Testing

**Testing Framework:** Vitest + React Testing Library
**Test Locations:**
- `/components/story/StoryIntroScreen.test.tsx`
- `/components/story/StoryFinaleScreen.test.tsx`
- `/__tests__/integration/story-intro-finale-flow.test.ts`

**Test Scenarios:**
```typescript
describe('StoryIntroScreen', () => {
  it('renders intro content', () => {
    render(
      <StoryIntroScreen
        theme="space"
        wordListName="My Words"
        wordCount={10}
        onBegin={vi.fn()}
      />
    )

    expect(screen.getByText(/Begin Your Journey/i)).toBeInTheDocument()
    expect(screen.getByText(/10 words/i)).toBeInTheDocument()
  })

  it('calls onBegin when button clicked', async () => {
    const mockOnBegin = vi.fn()
    render(
      <StoryIntroScreen
        theme="space"
        wordListName="My Words"
        wordCount={10}
        onBegin={mockOnBegin}
      />
    )

    await userEvent.click(screen.getByText(/Let's Begin!/i))
    expect(mockOnBegin).toHaveBeenCalled()
  })
})

describe('StoryFinaleScreen', () => {
  const mockStats = {
    wordsMastered: 10,
    gamesPlayed: 25,
    timeSpent: 600,
    totalWords: 10
  }

  it('renders finale content and stats', () => {
    render(
      <StoryFinaleScreen
        theme="space"
        wordListName="My Words"
        stats={mockStats}
        onPracticeMore={vi.fn()}
        onTryNewWords={vi.fn()}
        onViewProgress={vi.fn()}
      />
    )

    expect(screen.getByText(/Mission Complete/i)).toBeInTheDocument()
    expect(screen.getByText('10')).toBeInTheDocument() // Words mastered
  })

  it('all action buttons work', async () => {
    const mockActions = {
      onPracticeMore: vi.fn(),
      onTryNewWords: vi.fn(),
      onViewProgress: vi.fn()
    }

    render(
      <StoryFinaleScreen
        theme="space"
        wordListName="My Words"
        stats={mockStats}
        {...mockActions}
      />
    )

    await userEvent.click(screen.getByText(/Practice More/i))
    expect(mockActions.onPracticeMore).toHaveBeenCalled()

    await userEvent.click(screen.getByText(/Try New Words/i))
    expect(mockActions.onTryNewWords).toHaveBeenCalled()

    await userEvent.click(screen.getByText(/View Progress/i))
    expect(mockActions.onViewProgress).toHaveBeenCalled()
  })
})
```

**Run Tests:**
```bash
npm run test
```

### Technical Constraints

- Animations: Smooth, 60fps
- Image loading: Preload to prevent flicker
- Stats count-up: Engaging but not too slow (<3 seconds)
- Mobile: Fully responsive, touch-friendly
- Accessibility: Keyboard navigation, ARIA labels
- Performance: No lag during transitions

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
