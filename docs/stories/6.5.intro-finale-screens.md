# Story 6.5: Enhance Story Intro & Finale Screens

## Status

Draft

## Parent Story

[Story 6.4: Create Story Mode Flow](./6.4.integrate-story-checkpoints.md)

## Dependencies

**Required (Must be complete first):**
- ✅ Story 6.4c: Story Intro & Finale Screens (base implementation)

## Story

**As a** child,
**I want** enhanced intro/finale screens with persistent tracking and more options,
**so that** I have a personalized experience that remembers my progress and gives me clear choices.

## Acceptance Criteria

1. Intro screen only shows once per word list (tracked in IndexedDB)
2. Intro screen has optional "Skip Intro" button
3. Intro screen displays word list name
4. Finale screen shows enhanced stats: words mastered, games played, time spent
5. Finale screen has 3 action buttons: "Practice More", "Try New Words", "View Progress"
6. Finale screen displays word list name
7. Custom hooks abstract intro/finale logic from components
8. Stats calculation helper computes session metrics
9. StorySessionMachine guards check intro tracking status
10. All features maintain existing responsive design and animations
11. TypeScript types updated throughout
12. Tests verify new features

## Tasks / Subtasks

- [ ] Add IndexedDB intro tracking
  - [ ] Create storage functions in `lib/storage/story-progress-storage.ts`:
    - `hasSeenStoryIntro(wordListId: string): Promise<boolean>`
    - `markStoryIntroAsSeen(wordListId: string): Promise<void>`
  - [ ] Use existing IndexedDB setup from story progress storage
  - [ ] Store data as: `{ wordListId, hasSeenIntro: true, timestamp }`
  - [ ] Handle errors gracefully (default to showing intro on failure)
  - [ ] Add JSDoc documentation

- [ ] Update StoryIntroScreen component
  - [ ] Add `wordListName: string` prop to interface
  - [ ] Add `onSkip?: () => void` optional prop
  - [ ] Display word list name in narrative area
  - [ ] Add "Skip Intro" button (small, bottom-right corner)
  - [ ] Update component tests to verify new props
  - [ ] Maintain existing animations and responsive design

- [ ] Update StoryFinaleScreen component
  - [ ] Add `wordListName: string` prop to interface
  - [ ] Expand `stats` prop to include:
    ```typescript
    stats: {
      totalWords: number
      wordsMastered: number
      gamesPlayed: number
      timeSpent: number // in seconds
      averageConfidence: number
    }
    ```
  - [ ] Add `onTryNewWords: () => void` callback prop
  - [ ] Display word list name in finale narrative
  - [ ] Add third button: "Try New Words ✨"
  - [ ] Update button layout for 3-button grid
  - [ ] Display all 5 stats in enhanced stats grid
  - [ ] Format time as "X minutes" or "X min Y sec"
  - [ ] Update component tests to verify new features
  - [ ] Maintain existing confetti and animations

- [ ] Create stats calculation helper
  - [ ] Create `lib/game/calculate-session-stats.ts`
  - [ ] Export function:
    ```typescript
    export function calculateSessionStats(
      wordStats: Map<string, WordStats>,
      gameResults: GameResult[],
      sessionStartTime: number
    ): SessionStats
    ```
  - [ ] Calculate total words from wordStats.size
  - [ ] Calculate words mastered (confidence >= 0.8)
  - [ ] Calculate games played from gameResults.length
  - [ ] Calculate time spent: `Date.now() - sessionStartTime`
  - [ ] Calculate average confidence from wordStats
  - [ ] Add unit tests for edge cases (empty stats, etc.)
  - [ ] Add JSDoc documentation

- [ ] Create useStoryIntro custom hook
  - [ ] Create `lib/hooks/useStoryIntro.ts`
  - [ ] Hook interface:
    ```typescript
    export function useStoryIntro(wordListId: string) {
      const [hasSeenIntro, setHasSeenIntro] = useState(false)
      const [isLoading, setIsLoading] = useState(true)

      // Load status from IndexedDB on mount
      // Return { hasSeenIntro, isLoading, markAsSeen }
    }
    ```
  - [ ] Load intro seen status from IndexedDB on mount
  - [ ] Provide `markAsSeen()` function to update status
  - [ ] Handle loading state properly
  - [ ] Handle errors (default to not seen)

- [ ] Create useStoryFinale custom hook
  - [ ] Create `lib/hooks/useStoryFinale.ts`
  - [ ] Hook interface:
    ```typescript
    export function useStoryFinale(
      wordStats: Map<string, WordStats>,
      gameResults: GameResult[],
      sessionStartTime: number
    ) {
      // Calculate if should show finale
      // Calculate stats
      // Return { shouldShowFinale, stats }
    }
    ```
  - [ ] Use calculateSessionStats helper
  - [ ] Determine shouldShowFinale: all words >= 80% confidence
  - [ ] Memoize calculations to prevent re-renders

- [ ] Update StorySessionMachine
  - [ ] Add `wordListId: string` to machine context
  - [ ] Add `hasSeenIntro: boolean` to machine context
  - [ ] Add `sessionStartTime: number` to machine context
  - [ ] Update `shouldShowStoryIntro` guard:
    ```typescript
    shouldShowStoryIntro: ({ context }) => {
      return !context.hasSeenIntro && context.storyModeEnabled
    }
    ```
  - [ ] Add `markIntroAsSeen` action to update context
  - [ ] Add `SKIP_INTRO` event handler (same behavior as START_STORY)
  - [ ] Add `TRY_NEW_WORDS` event handler to navigate to word lists

- [ ] Update app/story/page.tsx integration
  - [ ] Use `useStoryIntro` hook to load intro status
  - [ ] Pass wordListId to machine input
  - [ ] Pass sessionStartTime to machine context
  - [ ] Update StoryIntroScreen props:
    ```typescript
    <StoryIntroScreen
      introContent={state.context.introContent}
      theme={state.context.storyTheme}
      wordListName={state.context.wordList.name}
      onStart={() => send({ type: 'START_STORY' })}
      onSkip={() => send({ type: 'SKIP_INTRO' })}
    />
    ```
  - [ ] Update StoryFinaleScreen props:
    ```typescript
    <StoryFinaleScreen
      finaleContent={state.context.finaleContent}
      wordListName={state.context.wordList.name}
      stats={calculateSessionStats(...)}
      onPlayAgain={() => send({ type: 'RESTART_STORY' })}
      onTryNewWords={() => send({ type: 'TRY_NEW_WORDS' })}
      onViewProgress={() => router.push('/dashboard')}
    />
    ```

- [ ] Update TypeScript types
  - [ ] Update `StoryIntroScreenProps` in component
  - [ ] Update `StoryFinaleScreenProps` in component
  - [ ] Add `SessionStats` type to `types/session.ts`:
    ```typescript
    export interface SessionStats {
      totalWords: number
      wordsMastered: number
      gamesPlayed: number
      timeSpent: number
      averageConfidence: number
    }
    ```
  - [ ] Update machine context types

- [ ] Update component tests
  - [ ] **StoryIntroScreen.test.tsx** - Add tests:
    - Test: Word list name displays correctly
    - Test: Skip button calls onSkip
    - Test: Skip button is optional (doesn't break if undefined)
  - [ ] **StoryFinaleScreen.test.tsx** - Add tests:
    - Test: Word list name displays correctly
    - Test: All 5 stats display correctly
    - Test: Time formats correctly (minutes/seconds)
    - Test: "Try New Words" button calls onTryNewWords
    - Test: 3-button layout renders correctly
  - [ ] Run tests with `pnpm test`

- [ ] Create integration tests
  - [ ] Create `__tests__/story-intro-tracking.test.ts`
  - [ ] Test: Intro shows on first visit to word list
  - [ ] Test: Intro doesn't show on second visit
  - [ ] Test: Skip intro marks as seen
  - [ ] Test: Different word lists have independent tracking
  - [ ] Create `__tests__/story-finale-stats.test.ts`
  - [ ] Test: Stats calculate correctly from session data
  - [ ] Test: Time spent updates during session
  - [ ] Test: All 3 finale buttons navigate correctly

- [ ] Create unit tests for helpers
  - [ ] Create `lib/game/calculate-session-stats.test.ts`
  - [ ] Test: Calculates all stats correctly
  - [ ] Test: Handles empty stats gracefully
  - [ ] Test: Handles edge cases (0 games, 0 time)
  - [ ] Test: Averages confidence correctly

## Dev Notes

### Key Enhancements Over Story 6.4c

**Story 6.4c provided:**
- Base StoryIntroScreen and StoryFinaleScreen components
- Integration with StorySessionMachine
- Basic animations and confetti
- Component tests

**Story 6.5 adds:**
1. **Persistent Intro Tracking** - IndexedDB remembers if intro was seen per word list
2. **Skip Intro Option** - Users can skip intro if they've seen it before
3. **Enhanced Stats** - Shows games played and time spent (not just word counts)
4. **Third Finale Button** - "Try New Words" option for better navigation
5. **Word List Context** - Displays which word list the story is about
6. **Custom Hooks** - Cleaner abstraction with useStoryIntro and useStoryFinale
7. **Stats Helper** - Reusable calculateSessionStats function

### Component Props Evolution

**Before (6.4c):**
```typescript
interface StoryIntroScreenProps {
  introContent: { title: string; narrative: string; celebrationEmoji?: string } | null
  theme: string
  onStart: () => void
}

interface StoryFinaleScreenProps {
  finaleContent: { title: string; narrative: string; celebrationEmoji?: string } | null
  wordStats: Map<string, WordStats>
  onPlayAgain: () => void
}
```

**After (6.5):**
```typescript
interface StoryIntroScreenProps {
  introContent: { title: string; narrative: string; celebrationEmoji?: string } | null
  theme: string
  wordListName: string // NEW
  onStart: () => void
  onSkip?: () => void // NEW
}

interface StoryFinaleScreenProps {
  finaleContent: { title: string; narrative: string; celebrationEmoji?: string } | null
  wordListName: string // NEW
  stats: SessionStats // ENHANCED (was wordStats Map)
  onPlayAgain: () => void
  onTryNewWords: () => void // NEW
  onViewProgress: () => void
}
```

### IndexedDB Storage Schema

```typescript
// Store in 'story_intro_tracking' object store
interface StoryIntroTracking {
  wordListId: string // Primary key
  hasSeenIntro: boolean
  timestamp: number
}
```

### Stats Calculation Example

```typescript
// lib/game/calculate-session-stats.ts
export function calculateSessionStats(
  wordStats: Map<string, WordStats>,
  gameResults: GameResult[],
  sessionStartTime: number
): SessionStats {
  const totalWords = wordStats.size
  const wordsMastered = Array.from(wordStats.values())
    .filter(stats => stats.confidence >= 0.8).length

  const confidenceValues = Array.from(wordStats.values())
    .map(stats => stats.confidence)
  const averageConfidence = confidenceValues.length > 0
    ? confidenceValues.reduce((sum, val) => sum + val, 0) / confidenceValues.length
    : 0

  const gamesPlayed = gameResults.length
  const timeSpent = Math.floor((Date.now() - sessionStartTime) / 1000) // seconds

  return {
    totalWords,
    wordsMastered,
    gamesPlayed,
    timeSpent,
    averageConfidence
  }
}
```

### Dependencies

**Required:**
- ✅ Story 6.4c (base implementation)
- IndexedDB setup from Story 6.2 (StoryProgressMachine)

**Enables:**
- Story 6.7 (Testing) - More comprehensive testing scenarios

### Testing

**Test Framework:** Vitest + React Testing Library

**New Test Files:**
- `lib/game/calculate-session-stats.test.ts` - Unit tests for stats helper
- `lib/hooks/useStoryIntro.test.ts` - Hook tests (optional)
- `__tests__/story-intro-tracking.test.ts` - Integration tests
- `__tests__/story-finale-stats.test.ts` - Integration tests

**Updated Test Files:**
- `components/story/StoryIntroScreen.test.tsx` - Add skip and word list name tests
- `components/story/StoryFinaleScreen.test.tsx` - Add enhanced stats and third button tests

## Implementation Notes

### Skip Intro Button Design

```tsx
{/* Small, unobtrusive skip button */}
<motion.button
  onClick={onSkip}
  className="absolute bottom-4 right-4 px-4 py-2 bg-gray-700/50 text-white text-sm rounded-lg hover:bg-gray-600/70 transition-colors"
  whileHover={{ scale: 1.05 }}
  whileTap={{ scale: 0.95 }}
>
  Skip Intro →
</motion.button>
```

### Enhanced Stats Grid (5 stats)

```tsx
<div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
  <StatCard icon="📚" value={stats.totalWords} label="Total Words" />
  <StatCard icon="✅" value={stats.wordsMastered} label="Mastered" />
  <StatCard icon="🎮" value={stats.gamesPlayed} label="Games Played" />
  <StatCard icon="⏱️" value={formatTime(stats.timeSpent)} label="Time Spent" />
  <StatCard icon="⭐" value={`${Math.round(stats.averageConfidence * 100)}%`} label="Avg Score" />
</div>
```

### Time Formatting Helper

```typescript
function formatTime(seconds: number): string {
  const minutes = Math.floor(seconds / 60)
  const remainingSeconds = seconds % 60

  if (minutes === 0) {
    return `${seconds}s`
  } else if (remainingSeconds === 0) {
    return `${minutes}m`
  } else {
    return `${minutes}m ${remainingSeconds}s`
  }
}
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-21 | 2.0 | Rewritten as enhancement story building on 6.4c | James (Dev) |
| 2025-10-20 | 1.0 | Original draft (superseded) | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
