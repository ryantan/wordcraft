# Story 7.2: Dynamic Story Generation Service

## Status

Draft

## Parent Epic

[Epic 7: AI-Powered Story Generation]

## Dependencies

**Required (Must be complete first):**
- ✅ Epic 6: Story Mode (complete story generation system exists)
- ⏳ Story 7.1: OpenAI Integration Infrastructure

## Story

**As a** player,
**I want** dynamically generated story content that adapts to my chosen word list and theme,
**so that** each story session feels unique and contextually relevant to the words I'm learning.

## Acceptance Criteria

1. OpenAI generates complete story beats for any word list and theme combination
2. Generated content maintains existing beat structure (GameBeat, NarrativeBeat, etc.)
3. Story progression is coherent and contextually appropriate for chosen theme
4. API failures gracefully fall back to existing template system
5. Story generation completes within 3 seconds or falls back to templates
6. Generated narratives are age-appropriate and educational
7. Existing story mode functionality remains completely unchanged when fallback is used

## Tasks / Subtasks

- [ ] Implement OpenAI story generation service (AC: 1, 2, 3)
  - [ ] Create `lib/openai/story-service.ts` with generation logic
  - [ ] Build comprehensive prompts for each beat type
  - [ ] Parse OpenAI responses into existing beat interfaces
  - [ ] Ensure narrative coherence across all story beats

- [ ] Replace static generation in story-generator.ts (AC: 1, 7)
  - [ ] Modify `generateStory()` to call OpenAI service first
  - [ ] Maintain exact same function signature and return type
  - [ ] Preserve all existing template generation as fallback
  - [ ] Add feature flag to enable/disable OpenAI generation

- [ ] Implement robust fallback system (AC: 4, 5, 7)
  - [ ] Detect API failures and timeout scenarios
  - [ ] Automatically fall back to template system on any error
  - [ ] Log fallback events for monitoring
  - [ ] Ensure seamless user experience during fallbacks

- [ ] Content quality assurance (AC: 6)
  - [ ] Add content filtering for inappropriate material
  - [ ] Validate generated content structure and coherence
  - [ ] Ensure educational value and age-appropriateness
  - [ ] Handle edge cases like very long or very short word lists

- [ ] Performance optimization (AC: 5)
  - [ ] Implement request timeout (3 seconds maximum)
  - [ ] Add request queuing to prevent API rate limit issues
  - [ ] Optimize prompt size to reduce API response times
  - [ ] Add performance monitoring and logging

## Dev Notes

**Existing System Integration:**
- `generateStory()` in `lib/story/story-generator.ts` currently returns `GeneratedStory` synchronously
- Must maintain compatibility with `StorySessionMachine` which calls this during initialization
- Existing template functions serve as the perfect fallback mechanism
- Beat types (GameBeat, NarrativeBeat, ChoiceBeat, CheckpointBeat) are well-defined interfaces

**OpenAI Prompt Strategy:**
- Single comprehensive prompt that generates all story beats for the session
- Include word list, theme, and specific instructions for beat types
- Request structured JSON response matching existing interfaces
- Include examples of good story beats in the prompt

**Fallback Strategy:**
- Any API error, timeout, or invalid response triggers immediate fallback
- Fallback uses existing template system identically to current behavior
- User experience is identical whether using OpenAI or templates
- Feature flag allows instant rollback to template-only mode

### Testing

**Test Framework:** Vitest with integration tests
**Test Location:** `lib/openai/story-service.test.ts`, integration tests in `__tests__/story-generation.test.ts`
**Testing Strategy:** Mock OpenAI responses, test fallback scenarios, verify beat structure compliance
**User Testing:** Verify story mode experience is identical with successful OpenAI calls vs. template fallbacks

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-21 | 1.0 | Initial story creation for dynamic story generation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References  

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_