# Story 5.3: Implement Picture Reveal Game

## Status

Draft

## Story

**As a** child,
**I want** to reveal a hidden picture by spelling letters correctly,
**so that** I'm rewarded with a visual surprise that keeps me engaged.

## Acceptance Criteria

1. `PictureReveal` component is created in `/components/games/PictureReveal.tsx`
2. Component implements the `GameMechanicProps` interface
3. Component displays a pixelated/obscured image related to the word (e.g., cat picture for "cat")
4. On-screen keyboard or letter buttons allow user to spell the word letter-by-letter
5. Each correct letter reveals a portion of the hidden picture (progressive reveal)
6. Incorrect letters don't penalize but don't reveal picture
7. Game tracks attempts, time taken, hints used
8. Picture is fully revealed when word is complete with celebration animation
9. Component is categorized as visual learning style
10. Component supports difficulty: easy (clear image), medium (slightly obscured), hard (very pixelated)

## Tasks / Subtasks

- [ ] Create PictureReveal component (AC: 1, 2)
  - [ ] Create file `/components/games/PictureReveal.tsx`
  - [ ] Implement `GameMechanicProps` interface
  - [ ] Setup component state: spelled letters, revealed percentage, attempts

- [ ] Implement image selection and loading (AC: 3)
  - [ ] Create mapping: word → image URL
  - [ ] Source free images from unsplash, pixabay, or similar
  - [ ] Store images in `/public/images/games/picture-reveal/`
  - [ ] Implement fallback for words without specific images
  - [ ] Optimize images (WebP format, appropriate size)

- [ ] Implement progressive reveal effect (AC: 3, 5, 10)
  - [ ] Use CSS filters or canvas for pixelation/blur
  - [ ] **Easy difficulty**: Start with light blur (10px), reveal quickly
  - [ ] **Medium difficulty**: Start with moderate pixelation, gradual reveal
  - [ ] **Hard difficulty**: Start heavily pixelated, slow reveal
  - [ ] Calculate reveal percentage: `revealPercent = (correctLetters / totalLetters) * 100`
  - [ ] Apply blur/pixelation based on remaining percentage

- [ ] Create on-screen keyboard (AC: 4)
  - [ ] Display alphabet in QWERTY or ABC layout (configurable)
  - [ ] Highlight correct letters when selected (green)
  - [ ] Disable letters already guessed
  - [ ] Support keyboard input for desktop users
  - [ ] Large touch targets for mobile (min 44x44px)

- [ ] Implement letter spelling logic (AC: 5, 6)
  - [ ] Track user's spelled word as array of letters
  - [ ] On letter click:
    - Check if letter is in the word
    - If yes: Add to spelled word, reveal more picture
    - If no: Increment attempts, no reveal
  - [ ] Allow mistakes without failure (encourage exploration)
  - [ ] Progressively reveal image based on correct letters

- [ ] Create picture reveal animation (AC: 8)
  - [ ] Gradual blur/pixelation reduction per letter
  - [ ] Smooth transition using CSS or Framer Motion
  - [ ] Final reveal: Remove all effects, show full clarity
  - [ ] Success animation: Image zooms slightly, sparkle effects
  - [ ] Celebration message: "Great job!"

- [ ] Implement difficulty variations (AC: 10)
  - [ ] **Easy**:
    - Start blur: 5px
    - Final blur: 0px
    - Image hint: Show outline initially
  - [ ] **Medium**:
    - Start pixelation: 20px blocks
    - Final pixelation: 0px
    - No hints
  - [ ] **Hard**:
    - Start pixelation: 40px blocks
    - Noise/static overlay
    - Very gradual reveal

- [ ] Track game metrics (AC: 7)
  - [ ] Track total attempts (letter clicks)
  - [ ] Track correct vs incorrect guesses
  - [ ] Track time taken
  - [ ] Calculate isCorrect: word spelled successfully
  - [ ] Create `GameResult` on completion

- [ ] Add hints system
  - [ ] Hint reveals one correct letter position
  - [ ] Track hints used
  - [ ] Limit based on difficulty: Easy (3), Medium (2), Hard (1)

- [ ] Handle word completion (AC: 8)
  - [ ] Detect when all letters spelled correctly
  - [ ] Play success sound/animation
  - [ ] Show fully revealed picture
  - [ ] Display completion message
  - [ ] Call `onComplete` with game result

- [ ] Update game mechanic registration (AC: 9)
  - [ ] Verify `/lib/games/picture-reveal.ts` metadata
  - [ ] Update: `learningStyle: ['visual']`
  - [ ] Register in game registry

- [ ] Create component tests
  - [ ] Create test file `/components/games/PictureReveal.test.tsx`
  - [ ] Test: Image renders with blur/pixelation
  - [ ] Test: Keyboard displays all letters
  - [ ] Test: Correct letter reveals more of picture
  - [ ] Test: Incorrect letter doesn't reveal
  - [ ] Test: Word completion shows full picture
  - [ ] Run tests with `npm run test`

## Dev Notes

### Architecture Context

**File Structure:**
```
components/
├── games/
│   ├── PictureReveal.tsx
│   ├── PictureReveal.test.tsx
│   └── components/
│       └── OnScreenKeyboard.tsx  # Reusable keyboard

public/
├── images/
│   └── games/
│       └── picture-reveal/
│           ├── cat.webp
│           ├── dog.webp
│           └── [more words...]
```

**Image Mapping:**
```typescript
// lib/games/picture-reveal/imageMap.ts
export const WORD_IMAGES: Record<string, string> = {
  cat: '/images/games/picture-reveal/cat.webp',
  dog: '/images/games/picture-reveal/dog.webp',
  bird: '/images/games/picture-reveal/bird.webp',
  // ... more mappings
}

export function getImageForWord(word: string): string {
  return WORD_IMAGES[word.toLowerCase()] || '/images/games/picture-reveal/default.webp'
}
```

**Progressive Reveal Implementation:**
```typescript
'use client'

import { useState } from 'react'
import Image from 'next/image'
import type { GameMechanicProps } from '@/types'

export function PictureReveal({ word, difficulty, onComplete }: GameMechanicProps) {
  const [spelledLetters, setSpelledLetters] = useState<Set<string>>(new Set())
  const [attempts, setAttempts] = useState(0)

  const targetWord = word.toUpperCase()
  const uniqueLetters = new Set(targetWord.split(''))
  const revealPercent = (spelledLetters.size / uniqueLetters.size) * 100

  // Calculate blur based on reveal percentage
  const blurAmount = getBlurForDifficulty(difficulty, revealPercent)

  const handleLetterClick = (letter: string) => {
    setAttempts(prev => prev + 1)

    if (targetWord.includes(letter)) {
      const newSpelled = new Set(spelledLetters)
      newSpelled.add(letter)
      setSpelledLetters(newSpelled)

      // Check if word is complete
      if (newSpelled.size === uniqueLetters.size) {
        completeGame()
      }
    }
  }

  return (
    <div className="picture-reveal-container">
      {/* Hidden picture with progressive reveal */}
      <div className="picture-container">
        <Image
          src={getImageForWord(word)}
          alt="Hidden picture"
          width={400}
          height={400}
          style={{
            filter: `blur(${blurAmount}px)`,
            transition: 'filter 0.5s ease'
          }}
        />
      </div>

      {/* Word display */}
      <div className="word-slots">
        {targetWord.split('').map((letter, idx) => (
          <div key={idx} className="letter-slot">
            {spelledLetters.has(letter) ? letter : '_'}
          </div>
        ))}
      </div>

      {/* On-screen keyboard */}
      <OnScreenKeyboard
        onLetterClick={handleLetterClick}
        disabledLetters={Array.from(spelledLetters)}
      />

      {/* Progress indicator */}
      <div className="reveal-progress">
        Picture revealed: {Math.round(revealPercent)}%
      </div>
    </div>
  )
}

function getBlurForDifficulty(
  difficulty: string,
  revealPercent: number
): number {
  const maxBlur = difficulty === 'easy' ? 10 : difficulty === 'medium' ? 20 : 30
  const remainingPercent = 100 - revealPercent
  return (maxBlur * remainingPercent) / 100
}
```

**CSS Filter Approach:**
```css
/* Easy: Blur effect */
.picture-easy {
  filter: blur(10px);
  transition: filter 0.5s ease;
}

/* Medium: Pixelation effect */
.picture-medium {
  filter: blur(20px);
  image-rendering: pixelated;
}

/* Hard: Heavy pixelation */
.picture-hard {
  filter: blur(30px) contrast(0.8);
  image-rendering: pixelated;
}
```

**On-Screen Keyboard Component:**
```typescript
interface OnScreenKeyboardProps {
  onLetterClick: (letter: string) => void
  disabledLetters: string[]
}

export function OnScreenKeyboard({ onLetterClick, disabledLetters }: OnScreenKeyboardProps) {
  const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('')

  return (
    <div className="keyboard-grid">
      {alphabet.map(letter => (
        <button
          key={letter}
          onClick={() => onLetterClick(letter)}
          disabled={disabledLetters.includes(letter)}
          className="letter-key"
        >
          {letter}
        </button>
      ))}
    </div>
  )
}
```

### Dependencies

**Required:**
- Epic 3 games - Provides GameMechanicProps pattern
- Next.js Image component for optimization

**Image Sources:**
- Unsplash (free, high-quality)
- Pixabay (free, royalty-free)
- Pexels (free stock photos)

### Testing

**Testing Framework:** Vitest + React Testing Library
**Test Location:** `/components/games/PictureReveal.test.tsx`
**Coverage Target:** 70%+

**Test Scenarios:**
```typescript
describe('PictureReveal Game', () => {
  it('renders blurred image initially', () => {
    render(<PictureReveal word="cat" difficulty="medium" onComplete={vi.fn()} />)

    const image = screen.getByAltText('Hidden picture')
    expect(image).toHaveStyle({ filter: expect.stringContaining('blur') })
  })

  it('reveals picture as correct letters are guessed', () => {
    render(<PictureReveal word="cat" difficulty="easy" onComplete={vi.fn()} />)

    // Click C
    fireEvent.click(screen.getByText('C'))

    // Blur should reduce
    const image = screen.getByAltText('Hidden picture')
    // Assert blur amount decreased
  })

  it('completes game when all letters found', () => {
    const mockOnComplete = vi.fn()
    render(<PictureReveal word="cat" difficulty="easy" onComplete={mockOnComplete} />)

    // Click all unique letters
    fireEvent.click(screen.getByText('C'))
    fireEvent.click(screen.getByText('A'))
    fireEvent.click(screen.getByText('T'))

    expect(mockOnComplete).toHaveBeenCalled()
  })
})
```

**Run Tests:**
```bash
npm run test
```

### Technical Constraints

- Image optimization: WebP format, max 500KB per image
- Performance: Blur transitions should be smooth (CSS transitions)
- Accessibility: Provide alt text for screen readers
- Touch targets: Keyboard buttons min 44x44px
- Fallback: Generic image if word-specific image missing

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
