# Story 5.4: Implement Word Building Blocks Game

## Status

Draft

## Story

**As a** child,
**I want** to drag and drop letter tiles like building blocks to construct a word,
**so that** I can practice spelling through hands-on manipulation.

## Acceptance Criteria

1. `WordBuildingBlocks` component is created in `/components/games/WordBuildingBlocks.tsx`
2. Component implements the `GameMechanicProps` interface
3. Component displays letter tiles scattered at the bottom of the screen
4. Empty slots at the top represent positions where letters should be placed
5. User drags letter tiles to slot positions or taps tiles then taps slots
6. Visual feedback shows if letter is in correct position (green) or wrong position (red/yellow)
7. User can rearrange letters by dragging them between slots
8. Game tracks attempts, time taken, hints used
9. Component is categorized as kinesthetic/visual learning style
10. Component supports difficulty: easy (letters snap to place), medium (free placement), hard (must be exact order before checking)

## Tasks / Subtasks

- [ ] Create WordBuildingBlocks component (AC: 1, 2)
  - [ ] Create file `/components/games/WordBuildingBlocks.tsx`
  - [ ] Implement `GameMechanicProps` interface
  - [ ] Setup component state: letter positions, slot assignments, attempts

- [ ] Implement letter tiles (AC: 3)
  - [ ] Create `LetterTile` component with draggable functionality
  - [ ] Display all letters from the word as individual tiles
  - [ ] Randomize/shuffle tile order for challenge
  - [ ] Style tiles as colorful blocks (CSS or images)
  - [ ] Add shadow/3D effect for block appearance

- [ ] Implement empty slots (AC: 4)
  - [ ] Create slots equal to word length
  - [ ] Display as outlined boxes at top of screen
  - [ ] Show slot numbers or positions (1, 2, 3...)
  - [ ] Highlight current drop target on drag over

- [ ] Implement drag and drop (AC: 5, 7)
  - [ ] Use HTML5 Drag and Drop API or react-dnd
  - [ ] Make letter tiles draggable
  - [ ] Make slots droppable
  - [ ] Handle drag start, drag over, drop events
  - [ ] Allow swapping: dragging from slot to slot
  - [ ] Support touch drag for mobile devices

- [ ] Implement tap-to-place alternative (AC: 5)
  - [ ] For mobile/touch users
  - [ ] Tap letter tile to select (highlight)
  - [ ] Tap empty slot to place selected letter
  - [ ] Tap placed letter to return to tiles area

- [ ] Implement position validation (AC: 6)
  - [ ] **Easy/Medium difficulty**: Check after each letter placed
    - Green border if correct position
    - Yellow border if letter exists but wrong position
    - Red border if letter doesn't exist
  - [ ] **Hard difficulty**: Only check when "Check Word" clicked
    - No feedback until full word assembled

- [ ] Add visual feedback (AC: 6)
  - [ ] Correct position: Green glow, checkmark icon
  - [ ] Wrong position (letter exists): Yellow highlight
  - [ ] Wrong letter: Red highlight, shake animation
  - [ ] Slot occupation: Filled vs empty visual state

- [ ] Implement difficulty variations (AC: 10)
  - [ ] **Easy**:
    - Snap to grid: Letters auto-align to slots
    - Immediate feedback per letter
    - Duplicate letters allowed
    - Hints show correct first letter
  - [ ] **Medium**:
    - Free drag and drop
    - Feedback per letter
    - Allow rearrangement
  - [ ] **Hard**:
    - Must place all letters before checking
    - No per-letter feedback
    - Stricter validation

- [ ] Track game metrics (AC: 8)
  - [ ] Track attempts (letter placements)
  - [ ] Track time taken
  - [ ] Track rearrangements
  - [ ] Track hints used
  - [ ] Create `GameResult` on completion

- [ ] Handle word completion
  - [ ] Detect when all slots filled with correct letters
  - [ ] Validate word is correctly spelled
  - [ ] Play success animation (blocks stack/lock in place)
  - [ ] Call `onComplete` with game result

- [ ] Add hints system
  - [ ] Hint reveals correct position for one letter
  - [ ] Or highlights the next letter to place
  - [ ] Track hints used

- [ ] Update game mechanic registration (AC: 9)
  - [ ] Verify `/lib/games/word-building.ts` metadata
  - [ ] Update: `learningStyle: ['kinesthetic', 'visual']`
  - [ ] Register in game registry

- [ ] Create component tests
  - [ ] Create test file `/components/games/WordBuildingBlocks.test.tsx`
  - [ ] Test: Letter tiles render
  - [ ] Test: Slots render
  - [ ] Test: Drag and drop works
  - [ ] Test: Correct placement validates
  - [ ] Test: Word completion triggers onComplete
  - [ ] Run tests with `npm run test`

## Dev Notes

### Architecture Context

**File Structure:**
```
components/
├── games/
│   ├── WordBuildingBlocks.tsx
│   ├── WordBuildingBlocks.test.tsx
│   └── components/
│       ├── LetterTile.tsx
│       └── LetterSlot.tsx
```

**Implementation Approach - react-dnd:**
```typescript
'use client'

import { useState } from 'react'
import { DndContext, DragEndEvent } from '@dnd-kit/core'
import { LetterTile } from './components/LetterTile'
import { LetterSlot } from './components/LetterSlot'
import type { GameMechanicProps } from '@/types'

export function WordBuildingBlocks({ word, difficulty, onComplete }: GameMechanicProps) {
  const targetWord = word.toUpperCase()
  const letters = targetWord.split('')
  const shuffledLetters = shuffle([...letters])

  const [slotAssignments, setSlotAssignments] = useState<(string | null)[]>(
    Array(letters.length).fill(null)
  )
  const [availableTiles, setAvailableTiles] = useState<string[]>(shuffledLetters)

  const handleDragEnd = (event: DragEndEvent) => {
    const { active, over } = event

    if (!over) return

    const letter = active.data.current?.letter
    const slotIndex = over.data.current?.slotIndex

    if (slotIndex !== undefined) {
      // Place letter in slot
      const newSlots = [...slotAssignments]
      newSlots[slotIndex] = letter
      setSlotAssignments(newSlots)

      // Remove from available tiles
      const newTiles = availableTiles.filter(t => t !== letter)
      setAvailableTiles(newTiles)

      // Check if correct (for easy/medium)
      if (difficulty !== 'hard') {
        checkLetterPosition(letter, slotIndex)
      }

      // Check if word complete
      if (newSlots.every(slot => slot !== null)) {
        checkWordCompletion(newSlots)
      }
    }
  }

  const checkLetterPosition = (letter: string, index: number) => {
    if (targetWord[index] === letter) {
      // Correct position - show green
      return 'correct'
    } else if (targetWord.includes(letter)) {
      // Letter exists but wrong position - show yellow
      return 'exists'
    } else {
      // Wrong letter - show red
      return 'wrong'
    }
  }

  const checkWordCompletion = (slots: (string | null)[]) => {
    const assembled = slots.join('')

    if (assembled === targetWord) {
      completeGame(true)
    }
  }

  return (
    <DndContext onDragEnd={handleDragEnd}>
      <div className="word-building-container">
        {/* Empty slots at top */}
        <div className="slots-area">
          {slotAssignments.map((letter, idx) => (
            <LetterSlot
              key={idx}
              index={idx}
              letter={letter}
              status={letter ? checkLetterPosition(letter, idx) : 'empty'}
            />
          ))}
        </div>

        {/* Letter tiles at bottom */}
        <div className="tiles-area">
          {availableTiles.map((letter, idx) => (
            <LetterTile key={idx} letter={letter} />
          ))}
        </div>
      </div>
    </DndContext>
  )
}

function shuffle<T>(array: T[]): T[] {
  const shuffled = [...array]
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1))
    ;[shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]]
  }
  return shuffled
}
```

**LetterTile Component:**
```typescript
import { useDraggable } from '@dnd-kit/core'

interface LetterTileProps {
  letter: string
}

export function LetterTile({ letter }: LetterTileProps) {
  const { attributes, listeners, setNodeRef, transform, isDragging } = useDraggable({
    id: `tile-${letter}`,
    data: { letter }
  })

  const style = transform ? {
    transform: `translate3d(${transform.x}px, ${transform.y}px, 0)`,
    opacity: isDragging ? 0.5 : 1
  } : undefined

  return (
    <div
      ref={setNodeRef}
      style={style}
      {...attributes}
      {...listeners}
      className="letter-tile"
    >
      {letter}
    </div>
  )
}
```

**LetterSlot Component:**
```typescript
import { useDroppable } from '@dnd-kit/core'

interface LetterSlotProps {
  index: number
  letter: string | null
  status: 'empty' | 'correct' | 'exists' | 'wrong'
}

export function LetterSlot({ index, letter, status }: LetterSlotProps) {
  const { setNodeRef, isOver } = useDroppable({
    id: `slot-${index}`,
    data: { slotIndex: index }
  })

  const className = `letter-slot status-${status} ${isOver ? 'hover' : ''}`

  return (
    <div ref={setNodeRef} className={className}>
      {letter || '_'}
    </div>
  )
}
```

**Styling (Tailwind CSS):**
```css
.letter-tile {
  @apply w-16 h-16 bg-yellow-400 rounded-lg shadow-lg cursor-grab active:cursor-grabbing;
  @apply flex items-center justify-center text-3xl font-bold;
  @apply transition-transform hover:scale-110;
}

.letter-slot {
  @apply w-16 h-16 border-4 border-dashed border-gray-400 rounded-lg;
  @apply flex items-center justify-center text-3xl font-bold;
}

.letter-slot.status-correct {
  @apply border-green-500 bg-green-100;
}

.letter-slot.status-exists {
  @apply border-yellow-500 bg-yellow-100;
}

.letter-slot.status-wrong {
  @apply border-red-500 bg-red-100;
}

.letter-slot.hover {
  @apply bg-blue-100 scale-110;
}
```

### Dependencies

**Required:**
- `@dnd-kit/core` - Modern drag and drop for React
- OR HTML5 Drag and Drop API (native, no library)

**Installation:**
```bash
npm install @dnd-kit/core
```

### Testing

**Testing Framework:** Vitest + React Testing Library
**Test Location:** `/components/games/WordBuildingBlocks.test.tsx`
**Coverage Target:** 70%+

**Test Scenarios:**
```typescript
describe('WordBuildingBlocks Game', () => {
  it('renders letter tiles and slots', () => {
    render(<WordBuildingBlocks word="cat" difficulty="easy" onComplete={vi.fn()} />)

    expect(screen.getByText('C')).toBeInTheDocument()
    expect(screen.getByText('A')).toBeInTheDocument()
    expect(screen.getByText('T')).toBeInTheDocument()

    const slots = screen.getAllByRole('region') // or specific test-id
    expect(slots).toHaveLength(3)
  })

  it('validates correct letter placement', () => {
    render(<WordBuildingBlocks word="cat" difficulty="medium" onComplete={vi.fn()} />)

    // Simulate drag and drop
    // Assert validation feedback
  })

  it('completes game when word correct', () => {
    const mockOnComplete = vi.fn()
    render(<WordBuildingBlocks word="cat" difficulty="easy" onComplete={mockOnComplete} />)

    // Place all letters correctly
    // Assert onComplete called
    expect(mockOnComplete).toHaveBeenCalledWith(
      expect.objectContaining({ isCorrect: true })
    )
  })
})
```

**Run Tests:**
```bash
npm run test
```

### Technical Constraints

- Touch support: Ensure drag works on mobile
- Performance: Smooth drag animations (60fps)
- Accessibility: Keyboard navigation alternative
- Touch targets: Tiles min 44x44px
- Visual feedback: Clear indication of correct/wrong

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
